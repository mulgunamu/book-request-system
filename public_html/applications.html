<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ ì²­ ë„ì„œ ëª©ë¡ - êµë‚´ í¬ë§ë„ì„œ ì‹ ì²­ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- í—¤ë” -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="index.html" class="flex items-center text-blue-600 hover:text-blue-700">
                        <i class="fas fa-arrow-left mr-2"></i>
                        <i class="fas fa-book-open text-2xl mr-3"></i>
                        <h1 class="text-xl font-bold text-gray-900">ì‹ ì²­ ë„ì„œ ëª©ë¡</h1>
                    </a>
                </div>
                <nav class="flex space-x-4">
                    <a href="index.html" class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-search mr-1"></i>ë„ì„œê²€ìƒ‰
                    </a>
                    <a href="admin/index.html" class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-cog mr-1"></i>ê´€ë¦¬ì
                    </a>
                </nav>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- í•™ê¸‰ ì¸ì¦ ì„¹ì…˜ -->
        <div id="authSection" class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-lock text-blue-600 mr-2"></i>í•™ê¸‰ ì¸ì¦
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="grade" class="block text-sm font-medium text-gray-700 mb-1">í•™ë…„</label>
                    <select id="grade" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">í•™ë…„ ì„ íƒ</option>
                        <option value="1">1í•™ë…„</option>
                        <option value="2">2í•™ë…„</option>
                        <option value="3">3í•™ë…„</option>
                        <option value="4">4í•™ë…„</option>
                        <option value="5">5í•™ë…„</option>
                        <option value="6">6í•™ë…„</option>
                    </select>
                </div>
                <div>
                    <label for="class" class="block text-sm font-medium text-gray-700 mb-1">ë°˜</label>
                    <select id="class" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">ë°˜ ì„ íƒ</option>
                        <!-- í•™ë…„ ì„ íƒ ì‹œ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                    </select>
                </div>
                <div>
                    <label for="teacher" class="block text-sm font-medium text-gray-700 mb-1">ë‹´ì„êµì‚¬</label>
                    <input type="text" id="teacher" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ë‹´ì„êµì‚¬ ì´ë¦„ ì…ë ¥">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="class11^^">
                </div>
                <div class="flex items-end">
                    <button id="authenticateBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-key mr-1"></i>ì¸ì¦
                    </button>
                </div>
            </div>
            
            <div class="mt-3 text-sm text-gray-600">
                <i class="fas fa-info-circle mr-1"></i>
                ë¹„ë°€ë²ˆí˜¸ëŠ” ë‹´ì„ ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•˜ì„¸ìš”. (ì˜ˆ: 1í•™ë…„ 1ë°˜ â†’ class11^^)
            </div>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  (ì¸ì¦ í›„ í‘œì‹œ) -->
        <div id="mainContent" class="hidden">
            <!-- í•™ê¸‰ ì •ë³´ ë° ì˜ˆì‚° í˜„í™© -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                    <div class="mb-4 lg:mb-0">
                        <h2 class="text-lg font-semibold text-gray-900 mb-2">
                            <i class="fas fa-list text-blue-600 mr-2"></i>ì‹ ì²­ í˜„í™©
                        </h2>
                        <div id="classDisplay" class="text-gray-600">
                            í•™ê¸‰ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 rounded-lg p-4 lg:w-96">
                        <h3 class="font-semibold text-blue-900 mb-2">ì˜ˆì‚° í˜„í™©</h3>
                        <div class="flex justify-between text-sm mb-2">
                            <span>ì‚¬ìš© ê¸ˆì•¡:</span>
                            <span id="usedBudget" class="font-medium">0ì›</span>
                        </div>
                        <div class="flex justify-between text-sm mb-2">
                            <span>ì´ ì˜ˆì‚°:</span>
                            <span id="totalBudget" class="font-medium">500,000ì›</span>
                        </div>
                        <div class="flex justify-between text-sm mb-3">
                            <span>ì”ì—¬ ì˜ˆì‚°:</span>
                            <span id="remainingBudget" class="font-medium text-green-600">500,000ì›</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="budgetBar" class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div class="text-xs text-gray-600 mt-1">
                            <span id="budgetPercentage">0</span>% ì‚¬ìš©
                        </div>
                    </div>
                </div>
            </div>

            <!-- í•„í„° ë° ì•¡ì…˜ -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <div class="flex items-center space-x-4">
                        <div class="text-sm text-gray-600">
                            ì´ <span id="totalApplications" class="font-medium text-blue-600">0</span>ê¶Œ ì‹ ì²­
                        </div>
                        <div class="text-sm text-gray-600">
                            ì´ <span id="totalAmount" class="font-medium text-blue-600">0</span>ì›
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <select id="filterBy" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="all">ì „ì²´</option>
                            <option value="student">í•™ìƒìš©</option>
                            <option value="teacher">êµì‚¬ìš©</option>
                        </select>
                        
                        <select id="sortBy" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="recent">ìµœê·¼ ì‹ ì²­ìˆœ</option>
                            <option value="title">ë„ì„œëª…ìˆœ</option>
                            <option value="price">ê°€ê²©ìˆœ</option>
                        </select>
                        
                        <button id="exportBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm">
                            <i class="fas fa-download mr-1"></i>ë‚´ë³´ë‚´ê¸°
                        </button>
                    </div>
                </div>
            </div>

            <!-- ì‹ ì²­ ë„ì„œ ëª©ë¡ -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ë„ì„œ ì •ë³´
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ì €ì/ì¶œíŒì‚¬
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ê°€ê²©
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    êµ¬ë¶„
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ì‹ ì²­ì¼
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ì•¡ì…˜
                                </th>
                            </tr>
                        </thead>
                        <tbody id="applicationsTable" class="bg-white divide-y divide-gray-200">
                            <!-- ì‹ ì²­ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ë¹ˆ ìƒíƒœ -->
            <div id="emptyState" class="hidden text-center py-12">
                <i class="fas fa-inbox text-gray-400 text-4xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">ì‹ ì²­í•œ ë„ì„œê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                <p class="text-gray-600 mb-4">ë„ì„œë¥¼ ê²€ìƒ‰í•˜ì—¬ ì‹ ì²­í•´ë³´ì„¸ìš”.</p>
                <a href="index.html" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-search mr-2"></i>ë„ì„œ ê²€ìƒ‰í•˜ê¸°
                </a>
            </div>
        </div>
    </div>

    <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-xl mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-900">ì‹ ì²­ ì·¨ì†Œ í™•ì¸</h3>
                </div>
                
                <p class="text-gray-600 mb-6">
                    ì„ íƒí•œ ë„ì„œì˜ ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
                    ì·¨ì†Œëœ ì‹ ì²­ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                </p>
                
                <div class="flex justify-end space-x-3">
                    <button id="cancelDelete" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                        ì·¨ì†Œ
                    </button>
                    <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                        ì‹ ì²­ ì·¨ì†Œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì•Œë¦¼ í† ìŠ¤íŠ¸ -->
    <div id="toast" class="fixed top-4 right-4 max-w-sm w-full hidden z-50">
        <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-4">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i id="toastIcon" class="text-xl"></i>
                </div>
                <div class="ml-3 w-0 flex-1">
                    <p id="toastTitle" class="text-sm font-medium text-gray-900"></p>
                    <p id="toastMessage" class="mt-1 text-sm text-gray-500"></p>
                </div>
                <div class="ml-4 flex-shrink-0 flex">
                    <button id="closeToast" class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/api-client.js"></script>
    <script>
        /**
         * ì‹ ì²­ ëª©ë¡ í˜ì´ì§€ ì• í”Œë¦¬ì¼€ì´ì…˜
         */
        class ApplicationsApp {
            constructor() {
                this.currentClass = null;
                this.applications = [];
                this.filteredApplications = [];
                this.deleteTargetId = null;
                this.isAuthenticated = false;
                this.elements = {};
            }

            async init() {
                console.log('ğŸš€ Applications í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
                this.bindElements();
                this.bindEvents();
                // âœ… ìˆ˜ì •: í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ ì„¸ì…˜ ì¸ì¦ í™•ì¸
                await this.checkSessionAuth();
            }

            bindElements() {
                this.elements = {
                    // ì¸ì¦ ê´€ë ¨
                    authSection: document.getElementById('authSection'),
                    mainContent: document.getElementById('mainContent'),
                    grade: document.getElementById('grade'),
                    class: document.getElementById('class'),
                    teacher: document.getElementById('teacher'),
                    password: document.getElementById('password'),
                    authenticateBtn: document.getElementById('authenticateBtn'),
                    
                    // ê¸°ì¡´ ìš”ì†Œë“¤
                    classDisplay: document.getElementById('classDisplay'),
                    usedBudget: document.getElementById('usedBudget'),
                    totalBudget: document.getElementById('totalBudget'),
                    remainingBudget: document.getElementById('remainingBudget'),
                    budgetBar: document.getElementById('budgetBar'),
                    budgetPercentage: document.getElementById('budgetPercentage'),
                    
                    totalApplications: document.getElementById('totalApplications'),
                    totalAmount: document.getElementById('totalAmount'),
                    filterBy: document.getElementById('filterBy'),
                    sortBy: document.getElementById('sortBy'),
                    exportBtn: document.getElementById('exportBtn'),
                    
                    applicationsTable: document.getElementById('applicationsTable'),
                    emptyState: document.getElementById('emptyState'),
                    
                    deleteModal: document.getElementById('deleteModal'),
                    cancelDelete: document.getElementById('cancelDelete'),
                    confirmDelete: document.getElementById('confirmDelete')
                };
            }

            bindEvents() {
                // âœ… ìˆ˜ì •: í•™ë…„ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ê°•í™”
                this.elements.grade.addEventListener('change', () => {
                    console.log('ğŸ“š í•™ë…„ ì„ íƒë¨:', this.elements.grade.value);
                    this.loadClassList();
                });
                
                this.elements.authenticateBtn.addEventListener('click', () => this.authenticateClass());
                this.elements.password.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.authenticateClass();
                    }
                });
                
                // ê¸°ì¡´ ì´ë²¤íŠ¸ë“¤
                this.elements.filterBy.addEventListener('change', () => this.applyFilters());
                this.elements.sortBy.addEventListener('change', () => this.applyFilters());
                this.elements.exportBtn.addEventListener('click', () => this.exportApplications());
                
                this.elements.applicationsTable.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-btn')) {
                        const applicationId = e.target.closest('.delete-btn').dataset.id;
                        this.showDeleteConfirm(applicationId);
                    }
                });
                
                this.elements.cancelDelete.addEventListener('click', () => this.hideDeleteConfirm());
                this.elements.confirmDelete.addEventListener('click', () => this.deleteApplication());
                
                // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
                this.elements.deleteModal.addEventListener('click', (e) => {
                    if (e.target === this.elements.deleteModal) {
                        this.hideDeleteConfirm();
                    }
                });
            }

            // âœ… ìˆ˜ì •: í•™ê¸‰ ëª©ë¡ ë¡œë“œ íƒ€ì… ë¹„êµ ë¬¸ì œ í•´ê²°
            async loadClassList() {
                const grade = this.elements.grade.value;
                console.log('ğŸ“¡ loadClassList í˜¸ì¶œë¨. ì„ íƒëœ í•™ë…„:', grade);
                
                if (!grade) {
                    this.elements.class.innerHTML = '<option value="">ë°˜ ì„ íƒ</option>';
                    return;
                }
                
                try {
                    const response = await fetch('/api/classes/settings');
                    if (!response.ok) throw new Error('í•™ê¸‰ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    
                    const classes = await response.json();
                    console.log('ğŸ“Š ì „ì²´ í•™ê¸‰ ë°ì´í„°:', classes);
                    
                    // âœ… ìˆ˜ì •: íƒ€ì… ì•ˆì „í•œ ë¹„êµ (stringìœ¼ë¡œ í†µì¼)
                    const gradeClasses = classes.filter(cls => String(cls.grade) === String(grade));
                    console.log(`${grade}í•™ë…„ ë°˜ ëª©ë¡:`, gradeClasses);
                    
                    // âœ… ìˆ˜ì •: option valueë¥¼ classId í˜•íƒœë¡œ í†µì¼
                    this.elements.class.innerHTML = '<option value="">ë°˜ ì„ íƒ</option>' +
                        gradeClasses.map(cls => 
                            `<option value="${cls.classId}">${cls.class}ë°˜</option>`
                        ).join('');
                        
                    console.log(`âœ… ${grade}í•™ë…„ ${gradeClasses.length}ê°œ ë°˜ ì¶”ê°€ë¨`);
                        
                } catch (error) {
                    console.error('âŒ í•™ê¸‰ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                    Toast.show('ì˜¤ë¥˜', 'í•™ê¸‰ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                }
            }

            // âœ… ìˆ˜ì •: ì„¸ì…˜ ì¸ì¦ í™•ì¸ ë¡œì§ ê°•í™”
            async checkSessionAuth() {
                console.log('ğŸ” ì„¸ì…˜ ì¸ì¦ í™•ì¸ ì‹œì‘...');
                
                // URLì—ì„œ force=true íŒŒë¼ë¯¸í„° í™•ì¸
                const urlParams = new URLSearchParams(window.location.search);
                const forceAuth = urlParams.get('force') === 'true';
                
                if (forceAuth) {
                    console.log('âš ï¸ force=true íŒŒë¼ë¯¸í„°ë¡œ ì¸í•´ ì„¸ì…˜ ë¬´ì‹œ');
                    this.showAuthSection();
                    return;
                }

                // ì„¸ì…˜ìŠ¤í† ë¦¬ì§€ì—ì„œ ì¸ì¦ ì •ë³´ í™•ì¸
                const authInfo = JSON.parse(sessionStorage.getItem('classAuth') || 'null');
                console.log('ğŸ’¾ ì €ì¥ëœ ì¸ì¦ ì •ë³´:', authInfo);
                
                if (authInfo && authInfo.classId && authInfo.expiry > Date.now()) {
                    console.log('âœ… ìœ íš¨í•œ ì„¸ì…˜ ì¸ì¦ ì •ë³´ ë°œê²¬');
                    
                    try {
                        // ì„œë²„ì—ì„œ í•™ê¸‰ ì •ë³´ ì¡°íšŒ
                        const response = await fetch('/api/classes/settings');
                        if (response.ok) {
                            const classSettings = await response.json();
                            const classData = classSettings.find(cls => cls.classId === authInfo.classId);
                            
                            if (classData) {
                                console.log('ğŸ¯ í•™ê¸‰ ë°ì´í„° ë§¤ì¹­ ì„±ê³µ:', classData);
                                this.currentClass = classData;
                                this.isAuthenticated = true;
                                this.showMainContent();
                                this.loadClassInfo();
                                await this.loadApplications();
                                return;
                            } else {
                                console.log('âŒ ì„œë²„ì—ì„œ í•´ë‹¹ í•™ê¸‰ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                            }
                        } else {
                            console.log('âŒ ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨:', response.status);
                        }
                    } catch (error) {
                        console.error('âŒ ì„œë²„ í†µì‹  ì˜¤ë¥˜:', error);
                    }
                } else {
                    if (authInfo) {
                        console.log('â° ì„¸ì…˜ ë§Œë£Œë¨. ë§Œë£Œ ì‹œê°„:', new Date(authInfo.expiry));
                    } else {
                        console.log('ğŸ“ ì €ì¥ëœ ì¸ì¦ ì •ë³´ ì—†ìŒ');
                    }
                }
                
                // ì¸ì¦ ì •ë³´ê°€ ì—†ê±°ë‚˜ ë§Œë£Œë¨
                sessionStorage.removeItem('classAuth');
                console.log('ğŸ”“ ì¸ì¦ ì„¹ì…˜ í‘œì‹œ');
                this.showAuthSection();
            }

            // âœ… ìˆ˜ì •: í•™ê¸‰ ì¸ì¦ ë¡œì§ ê°œì„ 
            async authenticateClass() {
                const grade = this.elements.grade.value;
                const classValue = this.elements.class.value;
                const password = this.elements.password.value;
                
                console.log('ğŸ” ì¸ì¦ ì‹œë„:', { grade, classValue, password: '***' });
                
                if (!grade || !classValue || !password) {
                    Toast.show('ì…ë ¥ ì˜¤ë¥˜', 'í•™ë…„, ë°˜, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }
                
                // classValueê°€ ì´ë¯¸ classId í˜•íƒœì¸ì§€ í™•ì¸
                let classId = classValue;
                if (!classValue.includes('-')) {
                    classId = `${grade}-${classValue}`;
                }
                
                console.log('ğŸ¯ ìµœì¢… classId:', classId);
                
                try {
                    const response = await fetch('/api/classes/authenticate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            classId: classId,
                            password: password
                        })
                    });
                    
                    const result = await response.json();
                    console.log('ğŸ“¡ ì„œë²„ ì‘ë‹µ:', result);
                    
                    if (response.ok && result.success) {
                        // ì¸ì¦ ì„±ê³µ
                        this.currentClass = result.classInfo;
                        this.isAuthenticated = true;
                        
                        // ì„¸ì…˜ìŠ¤í† ë¦¬ì§€ì— ì¸ì¦ ì •ë³´ ì €ì¥ (2ì‹œê°„ ìœ ì§€)
                        const authData = {
                            classId: classId,
                            expiry: Date.now() + (2 * 60 * 60 * 1000)
                        };
                        sessionStorage.setItem('classAuth', JSON.stringify(authData));
                        
                        console.log('ğŸ’¾ ì„¸ì…˜ ì •ë³´ ì €ì¥:', authData);
                        Toast.show('ì¸ì¦ ì„±ê³µ', `${classId} í•™ê¸‰ìœ¼ë¡œ ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                        
                        // âœ… ìˆ˜ì •: UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ìƒˆë¡œê³ ì¹¨ ëŒ€ì‹ )
                        this.showMainContent();
                        this.loadClassInfo();
                        await this.loadApplications();
                        
                    } else {
                        console.log('âŒ ì¸ì¦ ì‹¤íŒ¨:', result.error);
                        Toast.show('ì¸ì¦ ì‹¤íŒ¨', result.error || 'ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                } catch (error) {
                    console.error('âŒ ì¸ì¦ ì˜¤ë¥˜:', error);
                    Toast.show('ì˜¤ë¥˜', 'ì¸ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }

            // UI í‘œì‹œ ë©”ì„œë“œë“¤
            showAuthSection() {
                this.elements.authSection.classList.remove('hidden');
                this.elements.mainContent.classList.add('hidden');
            }

            showMainContent() {
                this.elements.authSection.classList.add('hidden');
                this.elements.mainContent.classList.remove('hidden');
            }

            loadClassInfo() {
                if (this.currentClass) {
                    this.elements.classDisplay.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <div class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-medium">
                                ${this.currentClass.grade}í•™ë…„ ${this.currentClass.class}ë°˜
                            </div>
                            <div>
                                <span class="text-gray-600">ë‹´ì„:</span>
                                <span class="font-medium">${this.currentClass.teacher || 'ë‹´ì„ ë¯¸ë°°ì •'}</span>
                            </div>
                        </div>
                    `;
                    this.updateBudgetDisplay();
                }
            }

            // í•™ê¸‰ë³„ ì‹ ì²­ ëª©ë¡ ë¡œë“œ
            async loadApplications() {
                if (!this.currentClass) {
                    this.showEmptyState();
                    return;
                }

                this.applications = await Applications.getByClass(this.currentClass.classId);
                this.applyFilters();
            }

            applyFilters() {
                let filtered = [...this.applications];
                
                // í•„í„° ì ìš©
                const filterBy = this.elements.filterBy.value;
                if (filterBy === 'student') {
                    filtered = filtered.filter(app => !app.isTeacherBook);
                } else if (filterBy === 'teacher') {
                    filtered = filtered.filter(app => app.isTeacherBook);
                }
                
                // ì •ë ¬ ì ìš©
                const sortBy = this.elements.sortBy.value;
                filtered.sort((a, b) => {
                    switch (sortBy) {
                        case 'title':
                            return a.title.localeCompare(b.title);
                        case 'price':
                            return b.price - a.price;
                        case 'recent':
                        default:
                            return new Date(b.appliedAt) - new Date(a.appliedAt);
                    }
                });
                
                this.filteredApplications = filtered;
                this.displayApplications();
                this.updateStats();
            }

            displayApplications() {
                if (this.filteredApplications.length === 0) {
                    this.showEmptyState();
                    return;
                }

                this.elements.emptyState.classList.add('hidden');
                this.elements.applicationsTable.innerHTML = this.filteredApplications.map(app => this.createApplicationRow(app)).join('');
                
                // cover í•„ë“œê°€ ì—†ëŠ” ì‹ ì²­ë“¤ì˜ ì´ë¯¸ì§€ë¥¼ ì‹¤ì‹œê°„ ë¡œë“œ
                this.loadMissingCovers();
            }

            createApplicationRow(application) {
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-16 w-12">
                                    ${application.cover ? `
                                        <img src="${application.cover}" 
                                             alt="${Validator.escapeHtml(application.title)}" 
                                             class="h-16 w-12 object-cover rounded shadow-sm"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        <div class="h-16 w-12 bg-blue-100 rounded flex items-center justify-center" style="display: none;">
                                            <i class="fas fa-book text-blue-600 text-sm"></i>
                                        </div>
                                    ` : `
                                        <div class="book-cover-container h-16 w-12 bg-blue-100 rounded flex items-center justify-center" data-isbn="${application.isbn}">
                                            <i class="fas fa-book text-blue-600 text-sm"></i>
                                        </div>
                                    `}
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900 max-w-xs truncate" title="${Validator.escapeHtml(application.title)}">
                                        ${Validator.escapeHtml(application.title)}
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        ISBN: ${application.isbn}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${Validator.escapeHtml(application.author)}</div>
                            <div class="text-sm text-gray-500">${Validator.escapeHtml(application.publisher)}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${formatPrice(application.price)}ì›</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${application.isTeacherBook ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'}">
                                ${application.isTeacherBook ? 'êµì‚¬ìš©' : 'í•™ìƒìš©'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${formatDate(application.appliedAt)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="delete-btn text-red-600 hover:text-red-900 transition" data-id="${application.id}">
                                <i class="fas fa-trash mr-1"></i>ì·¨ì†Œ
                            </button>
                        </td>
                    </tr>
                `;
            }

            updateStats() {
                const totalCount = this.filteredApplications.length;
                const totalAmount = this.filteredApplications.reduce((sum, app) => sum + app.price, 0);
                
                this.elements.totalApplications.textContent = totalCount;
                this.elements.totalAmount.textContent = formatPrice(totalAmount);
            }

            async updateBudgetDisplay() {
                if (!this.currentClass) return;

                // 1. ì‹ ì²­ ëª©ë¡ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                const applications = await Applications.getByClass(this.currentClass.classId);
                const used = applications.reduce((sum, app) => sum + (app.price || 0), 0);

                // 2. ì˜ˆì‚° ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                const response = await fetch('/api/classes/settings');
                let total = 0;
                if (response.ok) {
                    const classSettings = await response.json();
                    const classData = classSettings.find(cls => cls.classId === this.currentClass.classId);
                    total = classData && typeof classData.budget === 'number' ? classData.budget : 0;
                }

                const remaining = total - used;
                const percentage = total > 0 ? Math.round((used / total) * 100) : 0;

                this.elements.usedBudget.textContent = formatPrice(used);
                this.elements.totalBudget.textContent = formatPrice(total);
                this.elements.remainingBudget.textContent = formatPrice(remaining);
                this.elements.budgetPercentage.textContent = percentage;
                this.elements.budgetBar.style.width = `${percentage}%`;

                // ìƒ‰ìƒ ì²˜ë¦¬
                if (percentage > 90) {
                    this.elements.budgetBar.className = 'bg-red-600 h-3 rounded-full transition-all duration-500';
                    this.elements.remainingBudget.className = 'font-medium text-red-600';
                } else if (percentage > 70) {
                    this.elements.budgetBar.className = 'bg-yellow-600 h-3 rounded-full transition-all duration-500';
                    this.elements.remainingBudget.className = 'font-medium text-yellow-600';
                } else {
                    this.elements.budgetBar.className = 'bg-blue-600 h-3 rounded-full transition-all duration-500';
                    this.elements.remainingBudget.className = 'font-medium text-green-600';
                }
            }

            showDeleteConfirm(applicationId) {
                this.deleteTargetId = applicationId;
                Modal.show('deleteModal');
            }

            hideDeleteConfirm() {
                this.deleteTargetId = null;
                Modal.hide('deleteModal');
            }

            deleteApplication() {
                if (!this.deleteTargetId) return;
                
                const success = Applications.remove(this.deleteTargetId);
                
                if (success) {
                    Toast.show('ì·¨ì†Œ ì™„ë£Œ', 'ë„ì„œ ì‹ ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    this.loadApplications();
                    this.updateBudgetDisplay();
                } else {
                    Toast.show('ì·¨ì†Œ ì‹¤íŒ¨', 'ì‹ ì²­ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
                
                this.hideDeleteConfirm();
            }

            exportApplications() {
                if (this.filteredApplications.length === 0) {
                    Toast.show('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨', 'ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }

                const exportData = this.filteredApplications.map(app => ({
                    'í•™ê¸‰': this.currentClass ? `${this.currentClass.grade}í•™ë…„ ${this.currentClass.class}ë°˜` : '',
                    'ë‹´ì„êµì‚¬': this.currentClass ? this.currentClass.teacher : '',
                    'ë„ì„œëª…': app.title,
                    'ì €ì': app.author,
                    'ì¶œíŒì‚¬': app.publisher,
                    'ê°€ê²©': app.price,
                    'êµ¬ë¶„': app.isTeacherBook ? 'êµì‚¬ìš©' : 'í•™ìƒìš©',
                    'ISBN': app.isbn,
                    'ì‹ ì²­ì¼': formatDate(app.appliedAt)
                }));

                const filename = `ë„ì„œì‹ ì²­ëª©ë¡_${this.currentClass ? this.currentClass.classId : 'unknown'}_${new Date().toISOString().split('T')[0]}.csv`;
                CSV.download(exportData, filename);
                
                Toast.show('ë‚´ë³´ë‚´ê¸° ì™„ë£Œ', 'CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }

            showEmptyState() {
                this.elements.applicationsTable.innerHTML = '';
                this.elements.emptyState.classList.remove('hidden');
                this.elements.totalApplications.textContent = '0';
                this.elements.totalAmount.textContent = '0';
            }

            /**
             * cover í•„ë“œê°€ ì—†ëŠ” ì‹ ì²­ë“¤ì˜ ì´ë¯¸ì§€ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¡œë“œ
             */
            async loadMissingCovers() {
                const coverContainers = document.querySelectorAll('.book-cover-container[data-isbn]');
                
                for (const container of coverContainers) {
                    const isbn = container.dataset.isbn;
                    
                    try {
                        // ì•Œë¼ë”˜ APIì—ì„œ ì´ë¯¸ì§€ URL ê°€ì ¸ì˜¤ê¸°
                        const coverUrl = await this.fetchBookCover(isbn);
                        
                        if (coverUrl) {
                            container.innerHTML = `
                                <img src="${coverUrl}" 
                                     alt="ë„ì„œ ì»¤ë²„" 
                                     class="h-16 w-12 object-cover rounded shadow-sm"
                                     onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\"fas fa-book text-blue-600 text-sm\\"></i>';">
                            `;
                        }
                    } catch (error) {
                        console.warn(`ISBN ${isbn} ì»¤ë²„ ë¡œë“œ ì‹¤íŒ¨:`, error);
                    }
                    
                    // API í˜¸ì¶œ ê°„ê²©
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
            }

            /**
             * ì•Œë¼ë”˜ APIì—ì„œ ë„ì„œ ì»¤ë²„ ì´ë¯¸ì§€ URL ê°€ì ¸ì˜¤ê¸°
             */
            async fetchBookCover(isbn) {
                try {
                    // í”„ë¡ì‹œë¥¼ í†µí•´ ì•Œë¼ë”˜ API í˜¸ì¶œ (CORS ë¬¸ì œ í•´ê²°)
                    const response = await fetch('/api/books/cover/' + isbn);
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.cover;
                    }
                } catch (error) {
                    console.warn('ì»¤ë²„ ì´ë¯¸ì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
                }
                
                return null;
            }
        }

        // âœ… ìˆ˜ì •: DOMContentLoadedì—ì„œ ë°”ë¡œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ Applications í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
            window.applicationsApp = new ApplicationsApp();
            window.applicationsApp.init();
        });

        function getClassIdFromQuery() {
            const params = new URLSearchParams(window.location.search);
            const grade = params.get('grade');
            const classNum = params.get('class');
            if (grade && classNum) {
                return `${grade}-${classNum}`;
            }
            return null;
        }
    </script>
</body>
</html>