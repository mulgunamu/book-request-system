/**
 * Î©îÏù∏ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò
 */

class BookRequestApp {
    constructor() {
        this.currentClass = null;
        this.currentBooks = [];
        this.isInitialized = false;
        this.isAuthenticated = false; // Ïù∏Ï¶ù ÏÉÅÌÉú
        this.authExpiry = null; // Ïù∏Ï¶ù ÎßåÎ£å ÏãúÍ∞Ñ
        
        // DOM ÏöîÏÜåÎì§
        this.elements = {};
        
        // ÎîîÎ∞îÏö¥Ïä§Îêú Í≤ÄÏÉâ Ìï®Ïàò
        this.debouncedSearch = debounce(this.handleSearch.bind(this), 300);
        
        // ÏïåÎùºÎîò API Ïù∏Ïä§ÌÑ¥Ïä§Î•º Ï†ÑÏó≠ÏúºÎ°ú ÏÑ§Ï†ï
        if (!window.aladinAPI) {
            window.aladinAPI = new AladinAPI();
        }
    }

    /**
     * Ïï± Ï¥àÍ∏∞Ìôî
     */
    async init() {
        try {
            console.log('üöÄ BookRequestApp Ï¥àÍ∏∞Ìôî ÏãúÏûë');
            this.bindElements();
            this.bindEvents();
            
            // ÏÑ∏ÏÖòÏä§ÌÜ†Î¶¨ÏßÄ Í∏∞Î∞ò Ïù∏Ï¶ù Î≥µÏõê
            const restored = await this.checkSessionAuth();
            if (!restored) {
                // Ïù∏Ï¶ù Î≥µÏõê Ïã§Ìå® Ïãú Í∏∞Ï°¥ Î°úÏßÅ ÏàòÌñâ
                await this.restoreClassInfo();
            }
            // ÌïôÍ∏â Ï†ïÎ≥¥ Î≥µÏõê ÌõÑ Ïû¨ÌôïÏù∏
            setTimeout(() => {
                if (!this.currentClass) {
                    const savedClass = Storage.get('currentClass');
                    if (savedClass) {
                        console.log('üîÑ ÌïôÍ∏â Ï†ïÎ≥¥ Ïû¨ÏãúÎèÑ');
                        this.restoreClassInfo();
                    }
                }
            }, 1000);
            // Í∏∞Î≥∏ Ïπ¥ÌÖåÍ≥†Î¶¨ ÎèÑÏÑú Î°úÎìú
            await this.loadBooksByCategory('bestseller');
            console.log('‚úÖ BookRequestApp Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        } catch (error) {
            console.error('‚ùå Ïï± Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
            Toast.show('Ï¥àÍ∏∞Ìôî Ïò§Î•ò', 'Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }

    /**
     * DOM ÏöîÏÜå Î∞îÏù∏Îî©
     */
    bindElements() {
        this.elements = {
            // ÌïôÍ∏â Ï†ïÎ≥¥
            grade: document.getElementById('grade'),
            class: document.getElementById('class'),
            teacher: document.getElementById('teacher'),
            setClassBtn: document.getElementById('setClassBtn'),
            classInfo: document.getElementById('classInfo'),
            displayClass: document.getElementById('displayClass'),
            displayTeacher: document.getElementById('displayTeacher'),
            
            // ÏòàÏÇ∞ Ï†ïÎ≥¥
            usedBudget: document.getElementById('usedBudget'),
            totalBudget: document.getElementById('totalBudget'),
            budgetBar: document.getElementById('budgetBar'),
            
            // Í≤ÄÏÉâ Î∞è Ïπ¥ÌÖåÍ≥†Î¶¨
            searchInput: document.getElementById('searchInput'),
            searchBtn: document.getElementById('searchBtn'),
            searchType: document.getElementById('searchType'),
            searchSort: document.getElementById('searchSort'),
            recentOnly: document.getElementById('recentOnly'),
            inStockOnly: document.getElementById('inStockOnly'),
            categoryList: document.getElementById('categoryList'),
            currentCategory: document.getElementById('currentCategory'),
            sortBy: document.getElementById('sortBy'),
            
            // ÎèÑÏÑú Î™©Î°ù
            booksGrid: document.getElementById('booksGrid'),
            totalBooks: document.getElementById('totalBooks'),
            loadMoreBtn: document.getElementById('loadMoreBtn'),
            emptyState: document.getElementById('emptyState'),
            
            // Î™®Îã¨
            bookModal: document.getElementById('bookModal'),
            modalContent: document.getElementById('modalContent')
        };
    }

    /**
     * Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Î∞îÏù∏Îî©
     */
    bindEvents() {
        // ÌïôÍ∏â Ï†ïÎ≥¥ ÏÑ§Ï†ï
        if (this.elements.setClassBtn) {
            this.elements.setClassBtn.addEventListener('click', this.handleSetClass.bind(this));
        }
        
        // ÌïôÎÖÑ ÏÑ†ÌÉù Ïãú Ìï¥Îãπ ÌïôÎÖÑÏùò Î∞ò Î™©Î°ù Î°úÎìú
        if (this.elements.grade) {
            this.elements.grade.addEventListener('change', this.handleGradeChange.bind(this));
        }
        
        // Î∞ò ÏÑ†ÌÉù Ïãú Îã¥ÏûÑÍµêÏÇ¨ Ï†ïÎ≥¥ Î°úÎìú
        if (this.elements.class) {
            this.elements.class.addEventListener('change', this.handleClassChange.bind(this));
        }
        
        // Í≤ÄÏÉâ
        if (this.elements.searchInput) {
            this.elements.searchInput.addEventListener('input', (e) => {
                this.debouncedSearch(e.target.value);
            });
        }
        
        if (this.elements.searchBtn) {
            this.elements.searchBtn.addEventListener('click', () => {
                this.handleSearch(this.elements.searchInput.value);
            });
        }
        
        // ÏóîÌÑ∞ ÌÇ§Î°ú Í≤ÄÏÉâ
        if (this.elements.searchInput) {
            this.elements.searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.handleSearch(e.target.value);
                }
            });
        }
        
        // Ï†ïÎ†¨ Î≥ÄÍ≤Ω
        if (this.elements.sortBy) {
            this.elements.sortBy.addEventListener('change', this.handleSortChange.bind(this));
        }
        
        // ÎçîÎ≥¥Í∏∞ Î≤ÑÌäº
        if (this.elements.loadMoreBtn) {
            this.elements.loadMoreBtn.addEventListener('click', this.handleLoadMore.bind(this));
        }
        
        // Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäºÎì§
        if (this.elements.categoryList) {
            this.elements.categoryList.addEventListener('click', (e) => {
                const button = e.target.closest('.category-btn');
                if (button) {
                    this.handleCategoryClick(button);
                }
                
                const parentButton = e.target.closest('.category-parent-btn');
                if (parentButton) {
                    this.handleCategoryToggle(parentButton);
                }
            });
        }
        
        // Î™®Îã¨ Í¥ÄÎ†® Ïù¥Î≤§Ìä∏
        if (this.elements.modalContent) {
            this.elements.modalContent.addEventListener('click', this.handleModalClick.bind(this));
        }
        
        // Î™®Îã¨ Îã´Í∏∞
        const closeModal = document.getElementById('closeModal');
        if (closeModal) {
            closeModal.addEventListener('click', () => {
                Modal.hide('bookModal');
            });
        }
        
        // Î™®Îã¨ Î∞îÍπ• ÌÅ¥Î¶≠ÏúºÎ°ú Îã´Í∏∞
        if (this.elements.bookModal) {
            this.elements.bookModal.addEventListener('click', (e) => {
                if (e.target === this.elements.bookModal) {
                    Modal.hide('bookModal');
                }
            });
        }
        
        // ESC ÌÇ§Î°ú Î™®Îã¨ Îã´Í∏∞
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                Modal.hide('bookModal');
            }
        });
    }

    /**
     * ÏÑ∏ÏÖòÏä§ÌÜ†Î¶¨ÏßÄ Í∏∞Î∞ò Ïù∏Ï¶ù Î≥µÏõê
     */
    async checkSessionAuth() {
        const authInfo = JSON.parse(sessionStorage.getItem('classAuth') || 'null');
        if (authInfo && authInfo.classId && authInfo.expiry > Date.now()) {
            // ÏÑúÎ≤ÑÏóêÏÑú ÌïôÍ∏â Ï†ïÎ≥¥ Ï°∞Ìöå
            const response = await fetch('/api/classes/settings');
            if (response.ok) {
                const classSettings = await response.json();
                const classData = classSettings.find(cls => cls.classId === authInfo.classId);
                if (classData) {
                    this.currentClass = classData;
                    this.isAuthenticated = true;
                    this.authExpiry = authInfo.expiry;
                    // UI Í∞±Ïã†
                    if (this.elements.grade && this.elements.class) {
                        this.elements.grade.value = classData.grade;
                        await this.handleGradeChange();
                        this.elements.class.value = classData.class;
                        if (this.elements.teacher) this.elements.teacher.value = classData.teacher;
                    }
                    if (typeof this.loadClassInfo === 'function') this.loadClassInfo();
                    if (typeof this.updateBudgetDisplay === 'function') await this.updateBudgetDisplay();
                    return true;
                }
            }
        }
        sessionStorage.removeItem('classAuth');
        return false;
    }

    /**
     * Í≤∞Í≥º Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ (ÎçîÎ≥¥Í∏∞ Î≤ÑÌäº Ï†úÏñ¥ Î°úÏßÅ Ï†úÍ±∞ - Ï§ëÎ≥µ Î¨∏Ï†ú Ìï¥Í≤∞)
     */
    updateResultsInfo(results) {
        if (this.elements.totalBooks) {
            this.elements.totalBooks.textContent = results.totalResults;
        }
        
        // Í∏∞Ï°¥ Ï§ëÎ≥µ ÏΩîÎìú Ï†úÍ±∞:
        // const hasMore = results.books.length < results.totalResults;
        // this.elements.loadMoreBtn.classList.toggle('hidden', !hasMore);
        
        // ÎçîÎ≥¥Í∏∞ Î≤ÑÌäº Ï†úÏñ¥Îäî updateLoadMoreButton()ÏóêÏÑúÎßå Ï≤òÎ¶¨
    }

    /**
     * ÎçîÎ≥¥Í∏∞ Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏ (ÌÜµÌï©Îêú Î°úÏßÅ - Ï§ëÎ≥µ Î¨∏Ï†ú Ìï¥Í≤∞)
     */
    updateLoadMoreButton() {
        if (!this.elements.loadMoreBtn) return;
        
        if (!searchManager.lastResults) {
            this.elements.loadMoreBtn.classList.add('hidden');
            this.resetLoadMoreButton();
            return;
        }
        
        const currentCount = this.currentBooks.length;
        const totalCount = Math.min(200, searchManager.lastResults.totalResults); // API Ï†úÌïú Î∞òÏòÅ
        const hasMore = currentCount < totalCount && currentCount < 200; // ÏµúÎåÄ 200Í∞ú Ï†úÌïú
        
        // ÎçîÎ≥¥Í∏∞ Î≤ÑÌäº ÌëúÏãú/Ïà®ÍπÄ Ï≤òÎ¶¨
        this.elements.loadMoreBtn.classList.toggle('hidden', !hasMore);
        
        if (hasMore) {
            // Ï†ïÏÉÅÏ†ÅÏù∏ ÎçîÎ≥¥Í∏∞ ÏÉÅÌÉú
            this.elements.loadMoreBtn.innerHTML = `
                <i class="fas fa-plus mr-2"></i>Îçî ÎßéÏùÄ ÎèÑÏÑú Î≥¥Í∏∞ (${currentCount}/${totalCount})
            `;
            this.resetLoadMoreButton(); // Î≤ÑÌäº Ïä§ÌÉÄÏùº Ï¥àÍ∏∞Ìôî
        } else if (currentCount >= 200) {
            // API Ï†úÌïúÏóê ÎèÑÎã¨Ìïú Í≤ΩÏö∞
            this.elements.loadMoreBtn.innerHTML = `
                <i class="fas fa-info-circle mr-2"></i>API Ï†úÌïúÏúºÎ°ú ÏµúÎåÄ 200Í∞úÍπåÏßÄÎßå Ï°∞Ìöå Í∞ÄÎä•
            `;
            this.elements.loadMoreBtn.classList.remove('hidden');
            this.elements.loadMoreBtn.classList.add('cursor-not-allowed', 'opacity-60');
            this.elements.loadMoreBtn.disabled = true;
        } else {
            // Îçî Ïù¥ÏÉÅ Î°úÎìúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞
            this.elements.loadMoreBtn.classList.add('hidden');
            this.resetLoadMoreButton();
        }
    }

    /**
     * ÎçîÎ≥¥Í∏∞ Î≤ÑÌäº Ïä§ÌÉÄÏùº Ï¥àÍ∏∞Ìôî
     */
    resetLoadMoreButton() {
        if (!this.elements.loadMoreBtn) return;
        
        this.elements.loadMoreBtn.classList.remove('cursor-not-allowed', 'opacity-60');
        this.elements.loadMoreBtn.disabled = false;
    }

    /**
     * ÎèÑÏÑú Î™©Î°ù ÌëúÏãú (Í∏àÏßÄ ÌïÑÌÑ∞ Ï†ÅÏö©)
     */
    displayBooks(books) {
        try {
            // Í∏àÏßÄ ÌïÑÌÑ∞ Ï†ÅÏö©
            let filteredBooks = books;
            if (window.banFilterManager && window.banFilterManager.isInitialized) {
                filteredBooks = window.banFilterManager.filterBooks(books);
                
                // Í∏àÏßÄÎêú ÎèÑÏÑúÍ∞Ä ÏûàÎã§Î©¥ ÏïåÎ¶º ÌëúÏãú
                const bannedCount = books.length - filteredBooks.filter(book => !book.isBanned).length;
                if (bannedCount > 0) {
                    console.log(`‚ö†Ô∏è ${bannedCount}Í∞úÏùò Î∂ÄÏ†ÅÏ†àÌïú ÎèÑÏÑúÍ∞Ä ÌïÑÌÑ∞ÎßÅÎêòÏóàÏäµÎãàÎã§.`);
                }
            }
            
            if (!filteredBooks || filteredBooks.length === 0) {
                this.showEmptyState();
                return;
            }

            const booksHTML = filteredBooks.map(book => this.createBookCard(book)).join('');
            if (this.elements.booksGrid) {
                this.elements.booksGrid.innerHTML = booksHTML;
            }
            
            if (this.elements.emptyState) {
                this.elements.emptyState.classList.add('hidden');
            }
            
            // ÎçîÎ≥¥Í∏∞ Î≤ÑÌäºÏùÄ updateLoadMoreButton()ÏóêÏÑúÎßå Ï†úÏñ¥
            this.updateLoadMoreButton();
        } catch (error) {
            console.error('ÎèÑÏÑú ÌëúÏãú Ïò§Î•ò:', error);
            this.showEmptyState();
        }
    }

    /**
     * ÎèÑÏÑú Ïπ¥Îìú ÏÉùÏÑ± (Í∏àÏßÄ ÌïÑÌÑ∞ Ï†ïÎ≥¥ Ìè¨Ìï®)
     */
    createBookCard(book) {
        const isOwned = bookStatusManager?.isBookOwned(book) || false;
        const isApplied = bookStatusManager?.isBookApplied(book) || false;
        const isBanned = book.isBanned || false;
        const banReason = book.banReason || '';
        
        // Ïã†Ï≤≠ Í∞ÄÎä• Ïó¨Î∂Ä ÌåêÎã®
        let canApply = true;
        let statusText = 'Ïã†Ï≤≠ÌïòÍ∏∞';
        let statusClass = 'bg-blue-500 hover:bg-blue-600 text-white';
        
        if (isBanned) {
            canApply = false;
            statusText = 'Ïã†Ï≤≠ Î∂àÍ∞Ä';
            statusClass = 'bg-red-500 text-white cursor-not-allowed opacity-60';
        } else if (isOwned) {
            canApply = false;
            statusText = 'Î≥¥Ïú†Ï§ë';
            statusClass = 'bg-gray-500 text-white cursor-not-allowed opacity-60';
        } else if (isApplied) {
            canApply = false;
            statusText = 'Ïã†Ï≤≠ÏôÑÎ£å';
            statusClass = 'bg-green-500 text-white cursor-not-allowed opacity-60';
        }

        const priceDisplay = book.priceStandard 
            ? `${parseInt(book.priceStandard).toLocaleString()}Ïõê`
            : (book.price ? `${parseInt(book.price).toLocaleString()}Ïõê` : 'Í∞ÄÍ≤© Ï†ïÎ≥¥ ÏóÜÏùå');

        const discountPercent = book.discount > 0 ? Math.round(book.discount) : 0;
        const hasDiscount = discountPercent > 0;

        return `
            <div class="book-card bg-white rounded-lg shadow-sm hover:shadow-md transition-all duration-300 overflow-hidden relative ${isBanned ? 'border-2 border-red-200' : ''}" data-isbn="${book.isbn}">
                
                ${isBanned ? `
                    <div class="bg-red-100 border-b border-red-200 p-2">
                        <div class="flex items-center text-red-700 text-xs">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            <span class="font-medium">Î∂ÄÏ†ÅÏ†àÌïú ÎèÑÏÑú</span>
                        </div>
                        ${banReason ? `<div class="text-red-600 text-xs mt-1">${banReason}</div>` : ''}
                    </div>
                ` : ''}
                
                ${isOwned ? '<div class="status-overlay owned">Î≥¥Ïú†Ï§ë</div>' : ''}
                ${isApplied ? '<div class="status-overlay applied">Ïã†Ï≤≠ÏôÑÎ£å</div>' : ''}
                
                <div class="aspect-w-3 aspect-h-4 relative">
                    <img src="${book.cover}" 
                         alt="${book.title}" 
                         class="w-full h-48 object-cover"
                         loading="lazy"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI0MCIgdmlld0JveD0iMCAwIDIwMCAyNDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjQwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik02MCA4MEgxNDBWMTYwSDYwVjgwWiIgZmlsbD0iI0Q1RDdEQSIvPgo8L3N2Zz4K'">
                    
                    ${book.bestRank ? `
                        <div class="absolute top-2 left-2">
                            <span class="bg-yellow-500 text-white text-xs px-2 py-1 rounded-full">
                                Î≤†Ïä§Ìä∏ ${book.bestRank}ÏúÑ
                            </span>
                        </div>
                    ` : ''}
                    
                    ${hasDiscount ? `
                        <div class="absolute top-2 right-2">
                            <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">
                                ${discountPercent}% Ìï†Ïù∏
                            </span>
                        </div>
                    ` : ''}
                    
                    ${isBanned ? `
                        <div class="absolute inset-0 bg-red-500 bg-opacity-20 flex items-center justify-center">
                            <i class="fas fa-ban text-red-500 text-4xl opacity-80"></i>
                        </div>
                    ` : ''}
                </div>
                
                <div class="p-4">
                    <h3 class="font-semibold text-gray-900 mb-2 line-clamp-2 min-h-[3rem]">
                        ${book.title}
                    </h3>
                    
                    <div class="text-sm text-gray-600 mb-3 space-y-1">
                        <div class="flex items-center">
                            <i class="fas fa-user mr-2 text-gray-400"></i>
                            <span class="truncate">${book.author}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-building mr-2 text-gray-400"></i>
                            <span class="truncate">${book.publisher}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-calendar mr-2 text-gray-400"></i>
                            <span>${book.pubDate}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-won-sign mr-2 text-gray-400"></i>
                            <span class="font-medium">${priceDisplay}</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button class="apply-btn flex-1 px-4 py-3 rounded-lg font-medium transition-colors ${statusClass}"
                                data-isbn="${book.isbn}"
                                ${!canApply ? 'disabled' : ''}
                                title="${isBanned ? banReason : ''}">
                            ${statusText}
                        </button>
                        
                        ${book.link ? `
                            <a href="${book.link}" target="_blank" 
                               class="px-4 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * Í≤ÄÏÉâ Ï≤òÎ¶¨ (ÏàòÏ†ïÎêú Î≤ÑÏ†Ñ)
     */
    async handleSearch(query) {
        if (!query || query.trim() === '') {
            await this.loadBooksByCategory('bestseller');
            return;
        }

        try {
            Loading.show();
            if (this.elements.emptyState) {
                this.elements.emptyState.classList.add('hidden');
            }
            
            // Í≤ÄÏÉâ ÏòµÏÖò ÏàòÏßë
            const searchOptions = {
                queryType: this.elements.searchType?.value || 'Title',
                sort: this.elements.searchSort?.value || 'SalesPoint',
                maxResults: 50,
                start: 1
            };
            
            // ÌïÑÌÑ∞ ÏòµÏÖò Ï†ÅÏö©
            if (this.elements.recentOnly?.checked) {
                searchOptions.recentPublishFilter = 6; // ÏµúÍ∑º 6Í∞úÏõî
            }
            
            if (this.elements.inStockOnly?.checked) {
                searchOptions.outofStockfilter = 1; // ÌíàÏ†à Ï†úÏô∏
            }
            
            // Î∂ÄÍ∞Ä Ï†ïÎ≥¥ ÏöîÏ≤≠
            searchOptions.optResult = ['ratingInfo', 'bestSellerRank'];

            const results = await searchManager.search(query.trim(), searchOptions);
            
            if (results && results.books && results.books.length > 0) {
                this.currentBooks = results.books;
                this.displayBooks(this.currentBooks); // Í∏àÏßÄ ÌïÑÌÑ∞ Ï†ÅÏö©Îê®
                this.updateResultsInfo(results); // ÎçîÎ≥¥Í∏∞ Î≤ÑÌäº Ï†úÏñ¥ ÏΩîÎìú Ï†úÍ±∞Îê®
                this.updateBooksStatus();
                
                // ÌòÑÏû¨ Ïπ¥ÌÖåÍ≥†Î¶¨ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                if (this.elements.currentCategory) {
                    this.elements.currentCategory.textContent = `"${query}" Í≤ÄÏÉâ Í≤∞Í≥º`;
                }
                
                // Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
                this.updateCategoryButtons(null);
            } else {
                this.showEmptyState();
            }
        } catch (error) {
            console.error('Í≤ÄÏÉâ Ïò§Î•ò:', error);
            Toast.show('Í≤ÄÏÉâ Ïò§Î•ò', 'ÎèÑÏÑú Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            this.showEmptyState();
        } finally {
            Loading.hide();
        }
    }

    /**
     * Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÎèÑÏÑú Î°úÎìú (ÏàòÏ†ïÎêú Î≤ÑÏ†Ñ)
     */
    async loadBooksByCategory(categoryId) {
        try {
            if (this.elements.emptyState) {
                this.elements.emptyState.classList.add('hidden');
            }
            
            const results = await searchManager.searchByCategory(categoryId);
            if (results && results.books && results.books.length > 0) {
                this.currentBooks = results.books;
                this.displayBooks(this.currentBooks); // Í∏àÏßÄ ÌïÑÌÑ∞ Ï†ÅÏö©Îê®
                this.updateResultsInfo(results); // ÎçîÎ≥¥Í∏∞ Î≤ÑÌäº Ï†úÏñ¥ ÏΩîÎìú Ï†úÍ±∞Îê®
                
                // Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                this.updateCategoryButtons(categoryId);
            } else {
                this.currentBooks = [];
                this.showEmptyState();
            }
        } catch (error) {
            console.error('Ïπ¥ÌÖåÍ≥†Î¶¨ Î°úÎìú Ïò§Î•ò:', error);
            Toast.show('Î°úÎìú Ïò§Î•ò', 'ÎèÑÏÑú Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            this.showEmptyState();
        }
    }

    /**
     * Îπà ÏÉÅÌÉú ÌëúÏãú (ÏàòÏ†ïÎêú Î≤ÑÏ†Ñ)
     */
    showEmptyState() {
        if (this.elements.booksGrid) {
            this.elements.booksGrid.innerHTML = '';
        }
        
        if (this.elements.emptyState) {
            this.elements.emptyState.classList.remove('hidden');
        }
        
        if (this.elements.loadMoreBtn) {
            this.elements.loadMoreBtn.classList.add('hidden'); // ÎçîÎ≥¥Í∏∞ Î≤ÑÌäº Ïà®ÍπÄ
        }
        
        this.resetLoadMoreButton(); // Î≤ÑÌäº Ïä§ÌÉÄÏùº Ï¥àÍ∏∞Ìôî
        
        if (this.elements.totalBooks) {
            this.elements.totalBooks.textContent = '0';
        }
    }

    /**
     * ÎçîÎ≥¥Í∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠ Ï≤òÎ¶¨
     */
    async handleLoadMore() {
        if (!searchManager.lastResults || (this.elements.loadMoreBtn && this.elements.loadMoreBtn.disabled)) {
            return;
        }

        try {
            Loading.show('Ï∂îÍ∞Ä ÎèÑÏÑúÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...');
            
            // ÌòÑÏû¨ ÏãúÏûë ÏúÑÏπò Í≥ÑÏÇ∞
            const currentStart = this.currentBooks.length + 1;
            const searchOptions = {
                ...searchManager.lastSearchOptions,
                start: currentStart,
                maxResults: 50
            };

            let results;
            if (searchManager.lastQuery) {
                // Í≤ÄÏÉâ Í≤∞Í≥ºÏùò Îã§Ïùå ÌéòÏù¥ÏßÄ
                results = await searchManager.search(searchManager.lastQuery, searchOptions);
            } else if (searchManager.lastCategory) {
                // Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò Îã§Ïùå ÌéòÏù¥ÏßÄ
                results = await searchManager.searchByCategory(searchManager.lastCategory, searchOptions);
            } else {
                throw new Error('Î°úÎìúÌï† Ïàò ÏûàÎäî Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
            }

            if (results && results.books && results.books.length > 0) {
                // Í∏∞Ï°¥ ÎèÑÏÑúÏóê ÏÉà ÎèÑÏÑú Ï∂îÍ∞Ä
                this.currentBooks = [...this.currentBooks, ...results.books];
                this.displayBooks(this.currentBooks); // ÎçîÎ≥¥Í∏∞ Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ìè¨Ìï®
                this.updateBooksStatus();
                
                Toast.show('ÏôÑÎ£å', `${results.books.length}Í∞úÏùò Ï∂îÍ∞Ä ÎèÑÏÑúÎ•º Î∂àÎü¨ÏôîÏäµÎãàÎã§.`, 'success');
            } else {
                // Îçî Ïù¥ÏÉÅ Î°úÎìúÌï† ÎèÑÏÑúÍ∞Ä ÏóÜÏùå
                if (this.elements.loadMoreBtn) {
                    this.elements.loadMoreBtn.classList.add('hidden');
                }
                Toast.show('ÏïåÎ¶º', 'Îçî Ïù¥ÏÉÅ Î∂àÎü¨Ïò¨ ÎèÑÏÑúÍ∞Ä ÏóÜÏäµÎãàÎã§.', 'info');
            }
        } catch (error) {
            console.error('ÎçîÎ≥¥Í∏∞ Î°úÎìú Ïò§Î•ò:', error);
            Toast.show('Ïò§Î•ò', 'Ï∂îÍ∞Ä ÎèÑÏÑúÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        } finally {
            Loading.hide();
        }
    }

    /**
     * Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
     */
    updateCategoryButtons(activeCategory) {
        if (!this.elements.categoryList) return;
        
        const buttons = this.elements.categoryList.querySelectorAll('.category-btn');
        buttons.forEach(btn => {
            if (btn.dataset.category === activeCategory) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    /**
     * Ïπ¥ÌÖåÍ≥†Î¶¨ ÌÅ¥Î¶≠ Ï≤òÎ¶¨
     */
    handleCategoryClick(button) {
        const category = button.dataset.category;
        
        // Î™®Îì† Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäºÏóêÏÑú active ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
        if (this.elements.categoryList) {
            this.elements.categoryList.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }
        
        // ÌÅ¥Î¶≠Îêú Î≤ÑÌäºÏóê active ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
        button.classList.add('active');
        
        // Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ ÌëúÏãú
        const categoryName = button.textContent.trim().replace(/^\s*‚Ä¢\s*/, ''); // Î∂àÎ¶ø Ìè¨Ïù∏Ìä∏ Ï†úÍ±∞
        if (this.elements.currentCategory) {
            this.elements.currentCategory.textContent = categoryName;
        }
        
        // Í≤ÄÏÉâ ÏûÖÎ†•Ï∞Ω Ï¥àÍ∏∞Ìôî
        if (this.elements.searchInput) {
            this.elements.searchInput.value = '';
        }
        
        // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÎèÑÏÑú Î°úÎìú
        this.loadBooksByCategory(category);
    }

    /**
     * Ïπ¥ÌÖåÍ≥†Î¶¨ ÌÜ†Í∏Ä Ï≤òÎ¶¨
     */
    handleCategoryToggle(button) {
        const categoryGroup = button.closest('.category-group');
        const subcategoryList = categoryGroup?.querySelector('.subcategory-list');
        
        if (!subcategoryList) return;
        
        // Îã§Î•∏ Ïπ¥ÌÖåÍ≥†Î¶¨ Í∑∏Î£πÎì§ Îã´Í∏∞
        if (this.elements.categoryList) {
            this.elements.categoryList.querySelectorAll('.category-group').forEach(group => {
                if (group !== categoryGroup) {
                    const otherBtn = group.querySelector('.category-parent-btn');
                    const otherList = group.querySelector('.subcategory-list');
                    if (otherBtn && otherList) {
                        otherBtn.classList.remove('expanded');
                        otherList.classList.remove('show');
                        otherList.classList.add('hidden');
                    }
                }
            });
        }
        
        // ÌòÑÏû¨ Ïπ¥ÌÖåÍ≥†Î¶¨ ÌÜ†Í∏Ä
        if (button.classList.contains('expanded')) {
            button.classList.remove('expanded');
            subcategoryList.classList.remove('show');
            setTimeout(() => {
                subcategoryList.classList.add('hidden');
            }, 300);
        } else {
            button.classList.add('expanded');
            subcategoryList.classList.remove('hidden');
            setTimeout(() => {
                subcategoryList.classList.add('show');
            }, 10);
        }
    }

    /**
     * Î™®Îã¨ ÌÅ¥Î¶≠ Ï≤òÎ¶¨
     */
    handleModalClick(e) {
        if (e.target.classList.contains('apply-btn')) {
            e.stopPropagation();
            const isbn = e.target.dataset.isbn;
            const book = this.currentBooks.find(b => b.isbn === isbn);
            if (book) {
                this.handleBookApplication(book);
            }
        }
    }

    /**
     * ÎèÑÏÑú Ïã†Ï≤≠ Ï≤òÎ¶¨ (Í∏àÏßÄ ÌïÑÌÑ∞ ÌôïÏù∏ Ï∂îÍ∞Ä)
     */
    async handleBookApplication(book) {
        try {
            // Í∏àÏßÄ ÎèÑÏÑú Ïû¨ÌôïÏù∏
            if (window.banFilterManager && window.banFilterManager.isInitialized) {
                const banCheck = window.banFilterManager.isBookBanned(book);
                if (banCheck.isBanned) {
                    Toast.show('Ïã†Ï≤≠ Î∂àÍ∞Ä', banCheck.reason, 'error');
                    return;
                }
            }

            // ÌïôÍ∏â Ï†ïÎ≥¥ ÌôïÏù∏
            if (!this.currentClass) {
                Toast.show('ÏïåÎ¶º', 'Î®ºÏ†Ä ÌïôÍ∏â Ï†ïÎ≥¥Î•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }

            // Ï§ëÎ≥µ Ïã†Ï≤≠ ÌôïÏù∏
            if (bookStatusManager?.isBookApplied(book)) {
                Toast.show('Ï§ëÎ≥µ Ïã†Ï≤≠', 'Ïù¥ÎØ∏ Ïã†Ï≤≠Ìïú ÎèÑÏÑúÏûÖÎãàÎã§.', 'warning');
                return;
            }

            // Í∏∞Î≥¥Ïú† ÎèÑÏÑú ÌôïÏù∏
            if (bookStatusManager?.isBookOwned(book)) {
                Toast.show('Í∏∞Î≥¥Ïú† ÎèÑÏÑú', 'Ïù¥ÎØ∏ Î≥¥Ïú†Ï§ëÏù∏ ÎèÑÏÑúÏûÖÎãàÎã§.', 'info');
                return;
            }

            // ÏòàÏÇ∞ ÌôïÏù∏
            const currentBudget = budgetManager?.getUsedBudget() || 0;
            const totalBudget = budgetManager?.getTotalBudget() || 500000;
            const bookPrice = parseInt(book.priceStandard || book.price || 0);
            
            if (currentBudget + bookPrice > totalBudget) {
                Toast.show('ÏòàÏÇ∞ Ï¥àÍ≥º', 'ÏòàÏÇ∞ÏùÑ Ï¥àÍ≥ºÌïòÏó¨ Ïã†Ï≤≠Ìï† Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                return;
            }

            // Ïã†Ï≤≠ Ï≤òÎ¶¨
            Loading.show('ÎèÑÏÑúÎ•º Ïã†Ï≤≠ÌïòÍ≥† ÏûàÏäµÎãàÎã§...');

            const application = {
                ...book,
                applicationDate: new Date().toISOString(),
                classInfo: this.currentClass,
                status: 'pending'
            };

            // Ïã†Ï≤≠ Î™©Î°ùÏóê Ï∂îÍ∞Ä
            let applications = JSON.parse(localStorage.getItem('bookApplications') || '[]');
            applications.push(application);
            localStorage.setItem('bookApplications', JSON.stringify(applications));

            // ÏòàÏÇ∞ ÏóÖÎç∞Ïù¥Ìä∏
            if (budgetManager) {
                budgetManager.addExpense(bookPrice, `ÎèÑÏÑúÏã†Ï≤≠: ${book.title}`);
            }

            // UI ÏóÖÎç∞Ïù¥Ìä∏
            this.updateBooksStatus();
            this.updateBudgetDisplay();

            Toast.show('Ïã†Ï≤≠ ÏôÑÎ£å', `"${book.title}" ÎèÑÏÑú Ïã†Ï≤≠Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.`, 'success');

        } catch (error) {
            console.error('ÎèÑÏÑú Ïã†Ï≤≠ Ïò§Î•ò:', error);
            Toast.show('Ïã†Ï≤≠ Ïò§Î•ò', 'ÎèÑÏÑú Ïã†Ï≤≠ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        } finally {
            Loading.hide();
        }
    }

    /**
     * ÎèÑÏÑú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
     */
    async updateBooksStatus() {
        if (this.currentBooks.length === 0) return;
        
        try {
            Loading.show('ÎèÑÏÑú ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÍ≥† ÏûàÏäµÎãàÎã§...');
            if (bookStatusManager) {
                this.currentBooks = await bookStatusManager.updateBooksStatus(this.currentBooks);
                this.displayBooks(this.currentBooks);
            }
        } catch (error) {
            console.error('ÎèÑÏÑú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
        } finally {
            Loading.hide();
        }
    }

    /**
     * ÌïôÍ∏â Ï†ïÎ≥¥ Î≥µÏõê
     */
    async restoreClassInfo() {
        const savedClass = Storage.get('currentClass');
        if (savedClass) {
            this.currentClass = savedClass;
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏
            if (this.elements.grade) this.elements.grade.value = savedClass.grade;
            if (this.elements.class) this.elements.class.value = savedClass.class;
            if (this.elements.teacher) this.elements.teacher.value = savedClass.teacher;
            
            this.loadClassInfo();
            await this.updateBudgetDisplay();
        }
    }

    /**
     * ÌïôÍ∏â Ï†ïÎ≥¥ ÌëúÏãú
     */
    loadClassInfo() {
        if (this.currentClass) {
            if (this.elements.displayClass) {
                this.elements.displayClass.textContent = `${this.currentClass.grade}ÌïôÎÖÑ ${this.currentClass.class}Î∞ò`;
            }
            if (this.elements.displayTeacher) {
                this.elements.displayTeacher.textContent = this.currentClass.teacher;
            }
            if (this.elements.classInfo) {
                this.elements.classInfo.classList.remove('hidden');
            }
        } else {
            if (this.elements.classInfo) {
                this.elements.classInfo.classList.add('hidden');
            }
        }
    }

    /**
     * ÏòàÏÇ∞ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
     */
    async updateBudgetDisplay() {
        try {
            if (!budgetManager) return;
            
            const budgetInfo = await budgetManager.getBudgetInfo();
            
            if (budgetInfo) {
                if (this.elements.usedBudget) {
                    this.elements.usedBudget.textContent = budgetInfo.used.toLocaleString();
                }
                if (this.elements.totalBudget) {
                    this.elements.totalBudget.textContent = budgetInfo.total.toLocaleString();
                }
                if (this.elements.budgetBar) {
                    const percentage = (budgetInfo.used / budgetInfo.total) * 100;
                    this.elements.budgetBar.style.width = `${Math.min(percentage, 100)}%`;
                }

                if (budgetInfo.used > budgetInfo.total * 0.9) {
                    Toast.show('ÏòàÏÇ∞ Í≤ΩÍ≥†', 'ÏòàÏÇ∞Ïùò 90%Î•º ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§.', 'warning');
                }
            }
        } catch (error) {
            console.error('‚ùå ÏòàÏÇ∞ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
        }
    }

    /**
     * ÌïôÎÖÑ Î≥ÄÍ≤Ω Ï≤òÎ¶¨
     */
    async handleGradeChange() {
        const grade = this.elements.grade?.value;
        
        // Î∞ò ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
        if (this.elements.class) {
            this.elements.class.innerHTML = '<option value="">Î∞ò ÏÑ†ÌÉù</option>';
        }
        if (this.elements.teacher) {
            this.elements.teacher.value = '';
        }
        
        // ÏòàÏÇ∞ ÌòÑÌô© Ïà®Í∏∞Í∏∞
        this.currentClass = null;
        if (this.elements.classInfo) {
            this.elements.classInfo.classList.add('hidden');
        }
        
        if (!grade) {
            return;
        }

        try {
            // Ìï¥Îãπ ÌïôÎÖÑÏùò Î∞ò Î™©Î°ù Î°úÎìú
            const response = await fetch('/api/classes/settings');
            if (response.ok) {
                const classSettings = await response.json();
                const gradeClasses = classSettings.filter(cls => String(cls.grade) === String(grade));
                
                gradeClasses.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.class;
                    option.textContent = `${cls.class}Î∞ò`;
                    if (this.elements.class) {
                        this.elements.class.appendChild(option);
                    }
                });
            }
        } catch (error) {
            console.error('Î∞ò Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
        }
    }

    /**
     * Î∞ò Î≥ÄÍ≤Ω Ï≤òÎ¶¨
     */
    async handleClassChange() {
        const grade = this.elements.grade?.value;
        const classNum = this.elements.class?.value;
        
        if (!grade || !classNum) {
            return;
        }

        try {
            // Ìï¥Îãπ ÌïôÍ∏âÏùò Îã¥ÏûÑÍµêÏÇ¨ Ï†ïÎ≥¥ Î°úÎìú
            const response = await fetch('/api/classes/settings');
            if (response.ok) {
                const classSettings = await response.json();
                const classData = classSettings.find(cls => 
                    String(cls.grade) === String(grade) && String(cls.class) === String(classNum)
                );
                
                if (classData && this.elements.teacher) {
                    this.elements.teacher.value = classData.teacher || '';
                }
            }
        } catch (error) {
            console.error('Îã¥ÏûÑÍµêÏÇ¨ Ï†ïÎ≥¥ Î°úÎìú Ïò§Î•ò:', error);
        }
    }

    /**
     * ÌïôÍ∏â ÏÑ§Ï†ï Ï≤òÎ¶¨
     */
    async handleSetClass() {
        const grade = this.elements.grade?.value;
        const classNum = this.elements.class?.value;
        const teacher = this.elements.teacher?.value.trim();

        if (!grade || !classNum || !teacher) {
            Toast.show('ÏûÖÎ†• Ïò§Î•ò', 'Î™®Îì† Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
            return;
        }

        try {
            Loading.show('ÌïôÍ∏â Ï†ïÎ≥¥Î•º ÏÑ§Ï†ïÌïòÍ≥† ÏûàÏäµÎãàÎã§...');

            this.currentClass = {
                grade: parseInt(grade),
                class: parseInt(classNum),
                teacher: teacher,
                classId: `${grade}-${classNum}`
            };

            // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
            Storage.set('currentClass', this.currentClass);

            // ÏÑ∏ÏÖò Ïù∏Ï¶ù Ï†ïÎ≥¥ Ï†ÄÏû• (1ÏãúÍ∞Ñ)
            const authInfo = {
                classId: this.currentClass.classId,
                expiry: Date.now() + (60 * 60 * 1000)
            };
            sessionStorage.setItem('classAuth', JSON.stringify(authInfo));

            this.isAuthenticated = true;
            this.authExpiry = authInfo.expiry;

            this.loadClassInfo();
            await this.updateBudgetDisplay();

            Toast.show('ÏÑ§Ï†ï ÏôÑÎ£å', 'ÌïôÍ∏â Ï†ïÎ≥¥Í∞Ä ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§.', 'success');

        } catch (error) {
            console.error('ÌïôÍ∏â ÏÑ§Ï†ï Ïò§Î•ò:', error);
            Toast.show('ÏÑ§Ï†ï Ïò§Î•ò', 'ÌïôÍ∏â Ï†ïÎ≥¥ ÏÑ§Ï†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        } finally {
            Loading.hide();
        }
    }

    /**
     * Ï†ïÎ†¨ Î≥ÄÍ≤Ω Ï≤òÎ¶¨
     */
    handleSortChange() {
        if (this.currentBooks.length > 0) {
            const sortBy = this.elements.sortBy?.value || 'salesPoint';
            this.currentBooks = this.applySortToBooks(this.currentBooks, sortBy);
            this.displayBooks(this.currentBooks);
        }
    }

    /**
     * ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÇ¨Ïù¥Îìú Ï†ïÎ†¨ Ï†ÅÏö©
     */
    applySortToBooks(books, sortBy) {
        if (!books || books.length === 0) return books;
        
        const sortedBooks = [...books];
        
        switch (sortBy) {
            case 'salesPoint':
                return sortedBooks.sort((a, b) => (b.salesPoint || 0) - (a.salesPoint || 0));
            case 'publishTime':
                return sortedBooks.sort((a, b) => {
                    const dateA = new Date(a.pubDate || '1900-01-01');
                    const dateB = new Date(b.pubDate || '1900-01-01');
                    return dateB - dateA;
                });
            case 'customerReviewRank':
                return sortedBooks.sort((a, b) => (b.customerReviewRank || 0) - (a.customerReviewRank || 0));
            case 'title':
                return sortedBooks.sort((a, b) => {
                    const titleA = (a.title || '').toLowerCase();
                    const titleB = (b.title || '').toLowerCase();
                    return titleA.localeCompare(titleB, 'ko');
                });
            case 'priceAsc':
                return sortedBooks.sort((a, b) => (a.price || 0) - (b.price || 0));
            case 'priceDesc':
                return sortedBooks.sort((a, b) => (b.price || 0) - (a.price || 0));
            default:
                return sortedBooks;
        }
    }
}

// ÎîîÎ∞îÏö¥Ïä§ Ìï®Ïàò
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Ï†ÑÏó≠ Î≥ÄÏàò
let app;
let searchManager = {};
let bookStatusManager = {};
let budgetManager = {};

// DOM Î°úÎìú ÏôÑÎ£å Ïãú Ïï± Ï¥àÍ∏∞Ìôî
document.addEventListener('DOMContentLoaded', async () => {
    try {
        console.log('üöÄ DOM Î°úÎìú ÏôÑÎ£å, Ïï± Ï¥àÍ∏∞Ìôî ÏãúÏûë');
        
        // ÌïÑÏàò Îß§ÎãàÏ†ÄÎì§ Ï¥àÍ∏∞Ìôî ÌôïÏù∏
        if (typeof SearchManager !== 'undefined') {
            searchManager = new SearchManager();
        }
        
        if (typeof BookStatusManager !== 'undefined') {
            bookStatusManager = new BookStatusManager();
        }
        
        if (typeof BudgetManager !== 'undefined') {
            budgetManager = new BudgetManager();
        }
        
        // Í∏àÏßÄÎèÑÏÑú ÌïÑÌÑ∞ Îß§ÎãàÏ†Ä Ï¥àÍ∏∞Ìôî (ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå)
        if (typeof BanFilterManager !== 'undefined' && !window.banFilterManager) {
            window.banFilterManager = new BanFilterManager();
        }
        
        // Î©îÏù∏ Ïï± Ï¥àÍ∏∞Ìôî
        app = new BookRequestApp();
        await app.init();
        
        console.log('‚úÖ Î™®Îì† ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        
    } catch (error) {
        console.error('‚ùå Ïï± Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
        Toast?.show('Ï¥àÍ∏∞Ìôî Ïò§Î•ò', 'Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
    }
});

// Ï†ÑÏó≠ÏóêÏÑú ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎèÑÎ°ù window Í∞ùÏ≤¥Ïóê Ï∂îÍ∞Ä
window.app = app;