<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>입실초등학교 희망도서 신청시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        .book-card {
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .category-item {
            transition: all 0.2s ease;
        }
        
        .category-item:hover, .category-item.active {
            background-color: #3b82f6;
            color: white;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .modal {
            transition: all 0.3s ease;
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal.hide {
            opacity: 0;
            visibility: hidden;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .book-cover {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .no-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 헤더 -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-book text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">입실초등학교</h1>
                        <p class="text-blue-100">희망도서 신청시스템</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="admin-btn" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition">
                        <i class="fas fa-cog mr-2"></i>관리자
                    </button>
                    <button id="my-requests-btn" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition">
                        <i class="fas fa-list mr-2"></i>신청현황
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 학급 정보 입력 섹션 -->
    <section id="class-info-section" class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center space-x-4">
                    <label class="text-gray-700 font-medium">학년:</label>
                    <select id="grade-select" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">선택하세요</option>
                        <option value="1">1학년</option>
                        <option value="2">2학년</option>
                        <option value="3">3학년</option>
                        <option value="4">4학년</option>
                        <option value="5">5학년</option>
                        <option value="6">6학년</option>
                    </select>
                </div>
                <div class="flex items-center space-x-4">
                    <label class="text-gray-700 font-medium">반:</label>
                    <select id="class-select" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">선택하세요</option>
                    </select>
                </div>
                <div class="flex items-center space-x-4">
                    <label class="text-gray-700 font-medium">담임교사:</label>
                    <input type="text" id="teacher-input" placeholder="담임교사 성함을 입력하세요" 
                           class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-center space-x-4">
                    <div id="budget-info" class="text-sm text-gray-600 hidden">
                        <span>예산: </span><span id="budget-amount" class="font-semibold text-blue-600"></span>
                        <span class="mx-2">|</span>
                        <span>사용: </span><span id="used-amount" class="font-semibold text-red-600"></span>
                        <span class="mx-2">|</span>
                        <span>잔여: </span><span id="remaining-amount" class="font-semibold text-green-600"></span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 메인 콘텐츠 -->
    <main class="container mx-auto px-4 py-8">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- 사이드바 (카테고리) -->
            <aside class="lg:w-1/4">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">도서 카테고리</h2>
                    <ul class="space-y-2" id="category-list">
                        <li class="category-item active px-4 py-2 rounded-lg cursor-pointer" data-category="popular">
                            <i class="fas fa-star mr-2"></i>인기도서
                        </li>
                        <li class="category-item px-4 py-2 rounded-lg cursor-pointer" data-category="new">
                            <i class="fas fa-sparkles mr-2"></i>신간도서
                        </li>
                        <li class="category-item px-4 py-2 rounded-lg cursor-pointer" data-category="children">
                            <i class="fas fa-child mr-2"></i>어린이
                        </li>
                        <li class="category-item px-4 py-2 rounded-lg cursor-pointer" data-category="comic">
                            <i class="fas fa-laugh mr-2"></i>만화
                        </li>
                        <li class="category-item px-4 py-2 rounded-lg cursor-pointer" data-category="science">
                            <i class="fas fa-flask mr-2"></i>과학
                        </li>
                        <li class="category-item px-4 py-2 rounded-lg cursor-pointer" data-category="history">
                            <i class="fas fa-landmark mr-2"></i>역사
                        </li>
                        <li class="category-item px-4 py-2 rounded-lg cursor-pointer" data-category="art">
                            <i class="fas fa-palette mr-2"></i>예술
                        </li>
                        <li class="category-item px-4 py-2 rounded-lg cursor-pointer" data-category="language">
                            <i class="fas fa-language mr-2"></i>외국어
                        </li>
                    </ul>
                </div>
            </aside>

            <!-- 도서 목록 -->
            <section class="lg:w-3/4">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800" id="current-category-title">인기도서</h2>
                        <div class="flex items-center space-x-4">
                            <div class="relative">
                                <input type="text" id="search-input" placeholder="도서명, 저자명 검색..." 
                                       class="border border-gray-300 rounded-lg pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <button id="search-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                검색
                            </button>
                        </div>
                    </div>

                    <!-- 로딩 스피너 -->
                    <div id="loading" class="hidden flex justify-center items-center py-20">
                        <div class="loading-spinner"></div>
                        <span class="ml-3 text-gray-600">도서 정보를 불러오는 중...</span>
                    </div>

                    <!-- 도서 그리드 -->
                    <div id="books-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                        <!-- 도서 카드들이 동적으로 생성됩니다 -->
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- 도서 상세정보 모달 -->
    <div id="book-detail-modal" class="modal hide fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-90vh overflow-y-auto">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800">도서 상세정보</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="book-detail-content" class="p-6">
                <!-- 도서 상세정보가 동적으로 생성됩니다 -->
            </div>
        </div>
    </div>

    <!-- 관리자 페이지 모달 -->
    <div id="admin-modal" class="modal hide fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-90vh overflow-y-auto">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800">관리자 페이지</h3>
                <button id="close-admin-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <!-- API 키 설정 -->
                <div class="mb-8">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">API 키 설정</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 mb-2">카카오 API 키</label>
                            <input type="password" id="kakao-api-key" placeholder="카카오 REST API 키를 입력하세요" 
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2">
                            <p class="text-xs text-gray-500 mt-1">
                                <a href="https://developers.kakao.com" target="_blank" class="text-blue-500 hover:underline">
                                    카카오 개발자 센터에서 발급받으세요
                                </a>
                            </p>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">알라딘 TTB 키</label>
                            <input type="password" id="aladin-api-key" placeholder="알라딘 TTB 키를 입력하세요" 
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2">
                            <p class="text-xs text-gray-500 mt-1">
                                <a href="https://blog.aladin.co.kr/openapi" target="_blank" class="text-blue-500 hover:underline">
                                    알라딘 OpenAPI에서 발급받으세요
                                </a>
                            </p>
                        </div>
                    </div>
                    <button id="save-api-keys-btn" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                        API 키 저장
                    </button>
                </div>

                <!-- 학급 관리 -->
                <div class="mb-8">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">학급 관리</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 mb-2">학년</label>
                            <select id="admin-grade-select" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                <option value="">선택하세요</option>
                                <option value="1">1학년</option>
                                <option value="2">2학년</option>
                                <option value="3">3학년</option>
                                <option value="4">4학년</option>
                                <option value="5">5학년</option>
                                <option value="6">6학년</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">반</label>
                            <input type="number" id="admin-class-input" min="1" max="20" placeholder="반 번호" 
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">담임교사</label>
                            <input type="text" id="admin-teacher-input" placeholder="담임교사 성함" 
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">예산 (원)</label>
                            <input type="number" id="admin-budget-input" min="0" placeholder="학급 예산" 
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2">
                        </div>
                    </div>
                    <button id="add-class-btn" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                        학급 추가
                    </button>
                </div>

                <!-- 기존 도서 목록 업로드 -->
                <div class="mb-8">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">기존 도서 목록 업로드</h4>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                        <input type="file" id="excel-file-input" accept=".xlsx,.xls,.csv" class="hidden">
                        <div class="text-center">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600 mb-2">기존 도서 목록 파일을 업로드하세요</p>
                            <p class="text-sm text-gray-400 mb-4">Excel(.xlsx, .xls) 또는 CSV 파일만 지원됩니다</p>
                            <button id="upload-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                                파일 선택
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 학급 목록 -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">등록된 학급 목록</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full border border-gray-200 rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-gray-700">학급</th>
                                    <th class="px-4 py-2 text-left text-gray-700">담임교사</th>
                                    <th class="px-4 py-2 text-right text-gray-700">예산</th>
                                    <th class="px-4 py-2 text-right text-gray-700">사용금액</th>
                                    <th class="px-4 py-2 text-right text-gray-700">잔여예산</th>
                                    <th class="px-4 py-2 text-center text-gray-700">관리</th>
                                </tr>
                            </thead>
                            <tbody id="class-list-table">
                                <!-- 학급 목록이 동적으로 생성됩니다 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 알림 토스트 -->
    <div id="toast" class="fixed top-4 right-4 z-60 hidden">
        <div class="bg-white rounded-lg shadow-lg border-l-4 p-4 max-w-sm">
            <div class="flex items-center">
                <i id="toast-icon" class="text-xl mr-3"></i>
                <div>
                    <p id="toast-message" class="text-gray-800 font-medium"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let currentCategory = 'popular';
        let currentBooks = [];
        let classData = [];
        let existingBooks = [];
        let selectedClass = null;
        let apiKeys = { kakao: '', aladin: '' };

        // 샘플 도서 데이터
        const sampleBooks = {
            popular: [
                {
                    id: '9788901234567',
                    title: '마법의 숲 모험기',
                    author: '김동화',
                    publisher: '꿈나무출판사',
                    price: 12000,
                    image: 'https://via.placeholder.com/150x200/4F46E5/FFFFFF?text=마법의+숲',
                    isbn: '9788901234567',
                    description: '용감한 소년이 마법의 숲에서 겪는 신비로운 모험 이야기입니다.',
                    category: '어린이>창작동화'
                },
                {
                    id: '9788901234568',
                    title: '우주 탐험대의 비밀',
                    author: '박과학',
                    publisher: '미래출판사',
                    price: 15000,
                    image: 'https://via.placeholder.com/150x200/059669/FFFFFF?text=우주+탐험',
                    isbn: '9788901234568',
                    description: '우주의 신비를 탐험하는 어린이 과학 동화입니다.',
                    category: '어린이>과학'
                },
                {
                    id: '9788901234569',
                    title: '한국사 여행',
                    author: '이역사',
                    publisher: '역사나무',
                    price: 13000,
                    image: 'https://via.placeholder.com/150x200/DC2626/FFFFFF?text=한국사',
                    isbn: '9788901234569',
                    description: '재미있는 한국사 이야기를 통해 역사를 배워보세요.',
                    category: '어린이>역사'
                },
                {
                    id: '9788901234570',
                    title: '그림 그리기 대회',
                    author: '최예술',
                    publisher: '아트북스',
                    price: 11000,
                    image: 'https://via.placeholder.com/150x200/7C2D12/FFFFFF?text=그림+그리기',
                    isbn: '9788901234570',
                    description: '창의적인 그림 그리기를 통해 예술적 감성을 키워보세요.',
                    category: '어린이>예술'
                },
                {
                    id: '9788901234571',
                    title: '영어 동화나라',
                    author: 'John Smith',
                    publisher: '글로벌북스',
                    price: 14000,
                    image: 'https://via.placeholder.com/150x200/1D4ED8/FFFFFF?text=영어+동화',
                    isbn: '9788901234571',
                    description: '재미있는 영어 동화로 자연스럽게 영어를 배워보세요.',
                    category: '어린이>외국어'
                }
            ],
            new: [
                {
                    id: '9788901234572',
                    title: '신간 어린이 동화집',
                    author: '신간작가',
                    publisher: '신간출판사',
                    price: 18000,
                    image: 'https://via.placeholder.com/150x200/7C3AED/FFFFFF?text=신간+동화',
                    isbn: '9788901234572',
                    description: '2025년 신간 어린이 동화 모음집입니다.',
                    category: '어린이>창작동화'
                },
                {
                    id: '9788901234573',
                    title: '최신 과학 실험',
                    author: '과학박사',
                    publisher: '과학나라',
                    price: 22000,
                    image: 'https://via.placeholder.com/150x200/059669/FFFFFF?text=과학+실험',
                    isbn: '9788901234573',
                    description: '집에서 할 수 있는 재미있는 과학 실험들',
                    category: '어린이>과학'
                }
            ]
        };

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
            loadBooks(currentCategory);
            setupEventListeners();
        });

        // 시스템 초기화
        function initializeSystem() {
            loadClassData();
            loadExistingBooks();
            loadApiKeys();
        }

        // API 키 로드
        function loadApiKeys() {
            const savedKeys = localStorage.getItem('apiKeys');
            if (savedKeys) {
                apiKeys = JSON.parse(savedKeys);
                if (document.getElementById('kakao-api-key')) {
                    document.getElementById('kakao-api-key').value = apiKeys.kakao || '';
                }
                if (document.getElementById('aladin-api-key')) {
                    document.getElementById('aladin-api-key').value = apiKeys.aladin || '';
                }
            }
        }

        // API 키 저장
        function saveApiKeys() {
            apiKeys.kakao = document.getElementById('kakao-api-key').value;
            apiKeys.aladin = document.getElementById('aladin-api-key').value;
            localStorage.setItem('apiKeys', JSON.stringify(apiKeys));
            showToast('API 키가 저장되었습니다.', 'success');
        }

        // 이벤트 리스너 설정
        function setupEventListeners() {
            // 학급 정보 변경 이벤트
            document.getElementById('grade-select').addEventListener('change', updateClassOptions);
            document.getElementById('class-select').addEventListener('change', updateTeacherInfo);
            document.getElementById('teacher-input').addEventListener('input', validateClassInfo);

            // 카테고리 클릭 이벤트
            document.querySelectorAll('.category-item').forEach(item => {
                item.addEventListener('click', function() {
                    selectCategory(this.dataset.category);
                });
            });

            // 검색 이벤트
            document.getElementById('search-btn').addEventListener('click', performSearch);
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });

            // 모달 이벤트
            document.getElementById('close-modal-btn').addEventListener('click', closeBookDetailModal);
            document.getElementById('admin-btn').addEventListener('click', openAdminModal);
            document.getElementById('close-admin-modal-btn').addEventListener('click', closeAdminModal);

            // 관리자 이벤트
            document.getElementById('save-api-keys-btn').addEventListener('click', saveApiKeys);
            document.getElementById('add-class-btn').addEventListener('click', addClass);
            document.getElementById('upload-btn').addEventListener('click', () => {
                document.getElementById('excel-file-input').click();
            });
            document.getElementById('excel-file-input').addEventListener('change', handleFileUpload);
        }

        // 학급 옵션 업데이트
        function updateClassOptions() {
            const grade = document.getElementById('grade-select').value;
            const classSelect = document.getElementById('class-select');
            
            classSelect.innerHTML = '<option value="">선택하세요</option>';
            
            if (grade) {
                const gradeClasses = classData.filter(cls => cls.grade === grade);
                gradeClasses.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.classNumber;
                    option.textContent = `${cls.classNumber}반`;
                    classSelect.appendChild(option);
                });
            }
            updateBudgetInfo();
        }

        // 담임교사 정보 업데이트
        function updateTeacherInfo() {
            const grade = document.getElementById('grade-select').value;
            const classNumber = document.getElementById('class-select').value;
            const teacherInput = document.getElementById('teacher-input');
            
            if (grade && classNumber) {
                const classInfo = classData.find(cls => 
                    cls.grade === grade && cls.classNumber === classNumber
                );
                
                if (classInfo) {
                    teacherInput.value = classInfo.teacher;
                    selectedClass = classInfo;
                    updateBudgetInfo();
                }
            } else {
                teacherInput.value = '';
                selectedClass = null;
                updateBudgetInfo();
            }
        }

        // 예산 정보 업데이트
        function updateBudgetInfo() {
            const budgetInfo = document.getElementById('budget-info');
            const budgetAmount = document.getElementById('budget-amount');
            const usedAmount = document.getElementById('used-amount');
            const remainingAmount = document.getElementById('remaining-amount');

            if (selectedClass) {
                const used = selectedClass.usedBudget || 0;
                const remaining = selectedClass.budget - used;

                budgetAmount.textContent = `${selectedClass.budget.toLocaleString()}원`;
                usedAmount.textContent = `${used.toLocaleString()}원`;
                remainingAmount.textContent = `${remaining.toLocaleString()}원`;
                budgetInfo.classList.remove('hidden');
            } else {
                budgetInfo.classList.add('hidden');
            }
        }

        // 학급 정보 유효성 검사
        function validateClassInfo() {
            const grade = document.getElementById('grade-select').value;
            const classNumber = document.getElementById('class-select').value;
            const teacher = document.getElementById('teacher-input').value.trim();
            return grade && classNumber && teacher;
        }

        // 카테고리 선택
        function selectCategory(category) {
            currentCategory = category;
            
            // 활성 카테고리 업데이트
            document.querySelectorAll('.category-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('active');
            
            // 카테고리 제목 업데이트
            const categoryNames = {
                popular: '인기도서',
                new: '신간도서',
                children: '어린이 도서',
                comic: '만화',
                science: '과학',
                history: '역사',
                art: '예술',
                language: '외국어'
            };
            
            document.getElementById('current-category-title').textContent = categoryNames[category];
            loadBooks(category);
        }

        // 카카오 API로 도서 검색
        async function searchBooksKakao(query, page = 1, size = 20) {
            if (!apiKeys.kakao) {
                console.log('카카오 API 키가 없어서 샘플 데이터를 사용합니다.');
                return getSampleData(query);
            }

            try {
                const response = await fetch(`https://dapi.kakao.com/v3/search/book?query=${encodeURIComponent(query)}&page=${page}&size=${size}`, {
                    headers: {
                        'Authorization': `KakaoAK ${apiKeys.kakao}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('카카오 API 오류:', error);
                showToast('샘플 데이터를 사용합니다. API 키를 설정하면 실제 데이터를 볼 수 있습니다.', 'info');
                return getSampleData(query);
            }
        }

        // 샘플 데이터 반환
        function getSampleData(query) {
            const allBooks = [...sampleBooks.popular, ...sampleBooks.new];
            const filteredBooks = allBooks.filter(book => 
                book.title.includes(query) || 
                book.author.includes(query) ||
                ['인기도서', '신간', '어린이', '만화', '과학', '역사', '예술', '외국어'].includes(query)
            );

            return {
                documents: filteredBooks.map(book => ({
                    title: book.title,
                    authors: [book.author],
                    publisher: book.publisher,
                    price: book.price,
                    thumbnail: book.image,
                    isbn: book.isbn,
                    contents: book.description
                })),
                meta: { total_count: filteredBooks.length }
            };
        }

        // 도서 로드
        async function loadBooks(category) {
            showLoading(true);
            
            try {
                let books = [];
                
                if (category === 'popular' || category === 'new') {
                    // 샘플 데이터 사용
                    books = sampleBooks[category] || [];
                } else {
                    // 카테고리별 샘플 데이터
                    const categoryQuery = category;
                    const kakaoData = await searchBooksKakao(categoryQuery);
                    books = kakaoData.documents.map(book => ({
                        id: book.isbn,
                        title: book.title,
                        author: book.authors.join(', '),
                        publisher: book.publisher,
                        price: book.price || 0,
                        image: book.thumbnail,
                        isbn: book.isbn,
                        description: book.contents || '상세 정보가 없습니다.',
                        category: '일반'
                    }));
                }
                
                currentBooks = books;
                displayBooks();
            } catch (error) {
                console.error('도서 로드 오류:', error);
                showToast('도서 정보를 불러오는 중 오류가 발생했습니다.', 'error');
            } finally {
                showLoading(false);
            }
        }

        // 도서 표시
        function displayBooks() {
            const booksGrid = document.getElementById('books-grid');
            booksGrid.innerHTML = '';

            if (currentBooks.length === 0) {
                booksGrid.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-book text-4xl mb-4"></i>
                        <p>검색 결과가 없습니다.</p>
                        <p class="text-sm mt-2">API 키를 설정하면 더 많은 도서를 볼 수 있습니다.</p>
                    </div>
                `;
                return;
            }

            currentBooks.forEach(book => {
                const bookCard = createBookCard(book);
                booksGrid.appendChild(bookCard);
            });
        }

        // 도서 카드 생성
        function createBookCard(book) {
            const card = document.createElement('div');
            card.className = 'book-card bg-white rounded-lg p-4 cursor-pointer';
            card.onclick = () => openBookDetailModal(book);

            const imageElement = book.image 
                ? `<img src="${book.image}" alt="${book.title}" class="book-cover" onerror="this.outerHTML='<div class=\\"no-image\\"><i class=\\"fas fa-book text-2xl\\"></i></div>'">`
                : `<div class="no-image"><i class="fas fa-book text-2xl"></i></div>`;

            card.innerHTML = `
                <div class="mb-4">
                    ${imageElement}
                </div>
                <h3 class="font-semibold text-gray-800 text-sm mb-1 line-clamp-2" title="${book.title}">${book.title}</h3>
                <p class="text-gray-600 text-xs mb-2" title="${book.author}">${book.author}</p>
                <p class="text-blue-600 font-semibold text-sm">${book.price ? book.price.toLocaleString() + '원' : '가격 정보 없음'}</p>
            `;

            return card;
        }

        // 도서 상세정보 모달 열기
        function openBookDetailModal(book) {
            if (!validateClassInfo()) {
                showToast('학급 정보를 모두 입력해주세요.', 'warning');
                return;
            }

            const modal = document.getElementById('book-detail-modal');
            const content = document.getElementById('book-detail-content');

            const imageElement = book.image 
                ? `<img src="${book.image}" alt="${book.title}" class="w-full rounded-lg shadow-md" onerror="this.outerHTML='<div class=\\"w-full h-64 bg-gray-200 rounded-lg flex items-center justify-center\\"><i class=\\"fas fa-book text-4xl text-gray-400\\"></i></div>'">`
                : `<div class="w-full h-64 bg-gray-200 rounded-lg flex items-center justify-center"><i class="fas fa-book text-4xl text-gray-400"></i></div>`;

            content.innerHTML = `
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="md:w-1/3">
                        ${imageElement}
                    </div>
                    <div class="md:w-2/3">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">${book.title}</h2>
                        <div class="space-y-3 mb-6">
                            <p><span class="font-semibold text-gray-700">저자:</span> ${book.author}</p>
                            <p><span class="font-semibold text-gray-700">출판사:</span> ${book.publisher}</p>
                            <p><span class="font-semibold text-gray-700">가격:</span> <span class="text-blue-600 font-bold">${book.price ? book.price.toLocaleString() + '원' : '가격 정보 없음'}</span></p>
                            <p><span class="font-semibold text-gray-700">ISBN:</span> ${book.isbn}</p>
                            ${book.category ? `<p><span class="font-semibold text-gray-700">분류:</span> ${book.category}</p>` : ''}
                        </div>
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-700 mb-2">도서 소개</h4>
                            <p class="text-gray-600 leading-relaxed">${book.description}</p>
                        </div>
                        <div class="flex space-x-4">
                            <button onclick="requestBook('${book.id}')" class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition font-semibold">
                                <i class="fas fa-heart mr-2"></i>희망도서 신청
                            </button>
                            <button onclick="closeBookDetailModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-400 transition font-semibold">
                                취소
                            </button>
                        </div>
                    </div>
                </div>
            `;

            modal.classList.remove('hide');
            modal.classList.add('show');
        }

        // 도서 상세정보 모달 닫기
        function closeBookDetailModal() {
            const modal = document.getElementById('book-detail-modal');
            modal.classList.remove('show');
            modal.classList.add('hide');
        }

        // 도서 신청
        function requestBook(bookId) {
            const book = currentBooks.find(b => b.id === bookId);
            if (!book) return;

            if (!validateClassInfo()) {
                showToast('학급 정보를 모두 입력해주세요.', 'warning');
                return;
            }

            // 중복 도서 확인
            const duplicateBook = checkDuplicateBook(book);
            if (duplicateBook) {
                if (duplicateBook.status === 'available') {
                    showToast('해당 도서가 이미 도서관에 있습니다. 도서관에서 대출하세요.', 'info');
                } else if (duplicateBook.status === 'borrowed') {
                    showToast('해당 도서가 현재 대출 중입니다.', 'info');
                } else {
                    showToast('해당 도서가 우리 도서관에 있습니다.', 'info');
                }
                return;
            }

            // 예산 확인
            if (book.price && !checkBudget(book.price)) {
                showToast('신청 금액이 학급 예산을 초과합니다.', 'error');
                return;
            }

            // 신청 확인
            if (confirm(`"${book.title}"을(를) 희망도서로 신청하시겠습니까?`)) {
                processBookRequest(book);
                showToast('희망도서 신청이 완료되었습니다.', 'success');
                closeBookDetailModal();
                
                if (book.price && selectedClass) {
                    selectedClass.usedBudget = (selectedClass.usedBudget || 0) + book.price;
                    updateBudgetInfo();
                    saveClassData();
                }
            }
        }

        // 중복 도서 확인
        function checkDuplicateBook(book) {
            return existingBooks.find(existing => {
                if (existing.isbn && book.isbn && existing.isbn === book.isbn) {
                    return true;
                }
                
                const titleSimilarity = calculateSimilarity(
                    normalizeString(existing.title), 
                    normalizeString(book.title)
                );
                
                return titleSimilarity > 0.8;
            });
        }

        // 문자열 정규화
        function normalizeString(str) {
            if (!str) return '';
            return str.toLowerCase().replace(/\s+/g, '').replace(/[^\w가-힣]/g, '').trim();
        }

        // 문자열 유사도 계산
        function calculateSimilarity(str1, str2) {
            if (str1 === str2) return 1;
            
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1;
            
            const distance = levenshteinDistance(longer, shorter);
            return (longer.length - distance) / longer.length;
        }

        // 레벤슈타인 거리 계산
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let i = 0; i <= str1.length; i++) {
                matrix[0][i] = i;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        // 예산 확인
        function checkBudget(price) {
            if (!selectedClass || !price) return true;
            
            const used = selectedClass.usedBudget || 0;
            const remaining = selectedClass.budget - used;
            
            return remaining >= price;
        }

        // 도서 신청 처리
        function processBookRequest(book) {
            const grade = document.getElementById('grade-select').value;
            const classNumber = document.getElementById('class-select').value;
            const teacher = document.getElementById('teacher-input').value;

            const request = {
                id: Date.now(),
                bookId: book.id,
                title: book.title,
                author: book.author,
                publisher: book.publisher,
                price: book.price || 0,
                isbn: book.isbn,
                image: book.image,
                grade: grade,
                classNumber: classNumber,
                teacher: teacher,
                requestDate: new Date().toISOString(),
                status: 'pending'
            };

            let requests = JSON.parse(localStorage.getItem('bookRequests') || '[]');
            requests.push(request);
            localStorage.setItem('bookRequests', JSON.stringify(requests));
        }

        // 검색 수행
        async function performSearch() {
            const searchTerm = document.getElementById('search-input').value.trim();
            if (!searchTerm) {
                showToast('검색어를 입력해주세요.', 'warning');
                return;
            }

            showLoading(true);
            
            try {
                const kakaoData = await searchBooksKakao(searchTerm);
                currentBooks = kakaoData.documents.map(book => ({
                    id: book.isbn,
                    title: book.title,
                    author: book.authors.join(', '),
                    publisher: book.publisher,
                    price: book.price || 0,
                    image: book.thumbnail,
                    isbn: book.isbn,
                    description: book.contents || '상세 정보가 없습니다.',
                    category: '일반'
                }));
                
                displayBooks();
                document.getElementById('current-category-title').textContent = `검색 결과: "${searchTerm}"`;
                
                document.querySelectorAll('.category-item').forEach(item => {
                    item.classList.remove('active');
                });
            } catch (error) {
                console.error('검색 오류:', error);
                showToast('검색 중 오류가 발생했습니다.', 'error');
            } finally {
                showLoading(false);
            }
        }

        // 관리자 모달 열기
        function openAdminModal() {
            const modal = document.getElementById('admin-modal');
            modal.classList.remove('hide');
            modal.classList.add('show');
            loadClassListTable();
        }

        // 관리자 모달 닫기
        function closeAdminModal() {
            const modal = document.getElementById('admin-modal');
            modal.classList.remove('show');
            modal.classList.add('hide');
        }

        // 학급 추가
        function addClass() {
            const grade = document.getElementById('admin-grade-select').value;
            const classNumber = document.getElementById('admin-class-input').value;
            const teacher = document.getElementById('admin-teacher-input').value.trim();
            const budget = parseInt(document.getElementById('admin-budget-input').value) || 0;

            if (!grade || !classNumber || !teacher || budget <= 0) {
                showToast('모든 정보를 정확히 입력해주세요.', 'warning');
                return;
            }

            const existingClass = classData.find(cls => 
                cls.grade === grade && cls.classNumber === classNumber
            );

            if (existingClass) {
                showToast('이미 등록된 학급입니다.', 'warning');
                return;
            }

            const newClass = {
                id: Date.now(),
                grade: grade,
                classNumber: classNumber,
                teacher: teacher,
                budget: budget,
                usedBudget: 0
            };

            classData.push(newClass);
            saveClassData();
            loadClassListTable();
            updateClassOptions();

            document.getElementById('admin-grade-select').value = '';
            document.getElementById('admin-class-input').value = '';
            document.getElementById('admin-teacher-input').value = '';
            document.getElementById('admin-budget-input').value = '';

            showToast('학급이 성공적으로 추가되었습니다.', 'success');
        }

        // 학급 목록 테이블 로드
        function loadClassListTable() {
            const tbody = document.getElementById('class-list-table');
            tbody.innerHTML = '';

            if (classData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">등록된 학급이 없습니다.</td></tr>';
                return;
            }

            classData.forEach(cls => {
                const row = document.createElement('tr');
                const used = cls.usedBudget || 0;
                const remaining = cls.budget - used;

                row.innerHTML = `
                    <td class="px-4 py-2 border-b">${cls.grade}학년 ${cls.classNumber}반</td>
                    <td class="px-4 py-2 border-b">${cls.teacher}</td>
                    <td class="px-4 py-2 border-b text-right">${cls.budget.toLocaleString()}원</td>
                    <td class="px-4 py-2 border-b text-right">${used.toLocaleString()}원</td>
                    <td class="px-4 py-2 border-b text-right">${remaining.toLocaleString()}원</td>
                    <td class="px-4 py-2 border-b text-center">
                        <button onclick="deleteClass(${cls.id})" class="text-red-600 hover:text-red-800 transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        // 학급 삭제
        function deleteClass(classId) {
            if (confirm('정말로 이 학급을 삭제하시겠습니까?')) {
                classData = classData.filter(cls => cls.id !== classId);
                saveClassData();
                loadClassListTable();
                updateClassOptions();
                showToast('학급이 삭제되었습니다.', 'success');
            }
        }

        // 파일 업로드 처리
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.csv')) {
                showToast('현재는 CSV 파일만 지원됩니다.', 'warning');
                return;
            }

            showLoading(true);

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    const books = [];

                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const columns = line.split(',');
                        if (columns.length >= 3) {
                            books.push({
                                title: columns[0] ? columns[0].trim().replace(/"/g, '') : '',
                                author: columns[1] ? columns[1].trim().replace(/"/g, '') : '',
                                publisher: columns[2] ? columns[2].trim().replace(/"/g, '') : '',
                                isbn: columns[3] ? columns[3].trim().replace(/"/g, '') : '',
                                status: columns[4] ? columns[4].trim().replace(/"/g, '') : 'available'
                            });
                        }
                    }

                    existingBooks = books.filter(book => book.title);
                    saveExistingBooks();
                    showToast(`${existingBooks.length}권의 기존 도서 정보가 업로드되었습니다.`, 'success');
                } catch (error) {
                    console.error('파일 처리 오류:', error);
                    showToast('파일 처리 중 오류가 발생했습니다.', 'error');
                } finally {
                    showLoading(false);
                }
            };

            reader.onerror = function() {
                showToast('파일 읽기 중 오류가 발생했습니다.', 'error');
                showLoading(false);
            };

            reader.readAsText(file, 'UTF-8');
        }

        // 데이터 저장/로드 함수들
        function loadClassData() {
            classData = JSON.parse(localStorage.getItem('classData') || '[]');
        }

        function saveClassData() {
            localStorage.setItem('classData', JSON.stringify(classData));
        }

        function loadExistingBooks() {
            existingBooks = JSON.parse(localStorage.getItem('existingBooks') || '[]');
        }

        function saveExistingBooks() {
            localStorage.setItem('existingBooks', JSON.stringify(existingBooks));
        }

        // 유틸리티 함수들
        function showLoading(show) {
            const loading = document.getElementById('loading');
            const booksGrid = document.getElementById('books-grid');
            
            if (show) {
                loading.classList.remove('hidden');
                booksGrid.style.opacity = '0.5';
            } else {
                loading.classList.add('hidden');
                booksGrid.style.opacity = '1';
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const messageEl = document.getElementById('toast-message');

            const config = {
                success: { icon: 'fas fa-check-circle', color: 'text-green-500', border: 'border-green-500' },
                error: { icon: 'fas fa-exclamation-circle', color: 'text-red-500', border: 'border-red-500' },
                warning: { icon: 'fas fa-exclamation-triangle', color: 'text-yellow-500', border: 'border-yellow-500' },
                info: { icon: 'fas fa-info-circle', color: 'text-blue-500', border: 'border-blue-500' }
            };

            const currentConfig = config[type] || config.info;
            
            icon.className = `${currentConfig.icon} ${currentConfig.color}`;
            toast.querySelector('.bg-white').className = `bg-white rounded-lg shadow-lg border-l-4 ${currentConfig.border} p-4 max-w-sm`;
            messageEl.textContent = message;

            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // 모달 외부 클릭 시 닫기
        document.getElementById('book-detail-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeBookDetailModal();
            }
        });

        document.getElementById('admin-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAdminModal();
            }
        });
    </script>
</body>
</html>